import{h as Ft,i as M}from"https://app.framerstatic.com/chunk-DXGLR7XE.mjs";import{a as Mt,b as Ie,c as Vt,d as Ee,e as qt,f as jt}from"https://app.framerstatic.com/chunk-TB2SOEAF.mjs";import{b as Ot,e as I}from"https://app.framerstatic.com/chunk-UTK4JR6V.mjs";import{a as _t,b as Bt,c as zt,d as Ht}from"https://app.framerstatic.com/chunk-SE354WOV.mjs";import{a as Wt}from"https://app.framerstatic.com/chunk-5ARAOZY2.mjs";import{f as Q,i as Pt}from"https://app.framerstatic.com/chunk-GFDNSHBH.mjs";import{Jg as Dt,P as X,Vf as de,Wf as Et,Xf as O,Zf as kt,cg as xt,dg as Nt,eg as Ut,fg as At,gg as Ke,hg as Ye,ig as Ge,jg as Je,kd as It,kg as N,lg as Ze,mg as Lt,ng as Ce,qa as Tt}from"https://app.framerstatic.com/chunk-GVEIL7AP.mjs";import{e as vt}from"https://app.framerstatic.com/chunk-HQZYWAIC.mjs";import{f as Rt}from"https://app.framerstatic.com/chunk-TQ6SMIXL.mjs";import{mc as Ct}from"https://app.framerstatic.com/chunk-JQGQBMDT.mjs";import{dg as yt,ga as oe,l as ft,mm as bt,ms as St,ns as $e,os as wt,ps as Te,tb as Z,wd as gt,xb as ae,zb as ve}from"https://app.framerstatic.com/chunk-HOZEDTF7.mjs";import{a as Re}from"https://app.framerstatic.com/chunk-FNEHAGV6.mjs";import{d as mt}from"https://app.framerstatic.com/chunk-QGRQ6OP4.mjs";import{p as B}from"https://app.framerstatic.com/chunk-BMR3NPHE.mjs";import{d as pt,i as J}from"https://app.framerstatic.com/chunk-ZQUNXESX.mjs";import{a as Cr}from"https://app.framerstatic.com/chunk-T3QWMIW2.mjs";import{g as we}from"https://app.framerstatic.com/chunk-YSPPHHKT.mjs";import{da as ut,e as ht,ea as Se,m as be,u as b}from"https://app.framerstatic.com/chunk-QQLWBJFN.mjs";import{a as f,b as ye}from"https://app.framerstatic.com/chunk-WNSBRACC.mjs";import{e as Tr,j as l}from"https://app.framerstatic.com/chunk-AHQIRSXG.mjs";async function cn(o){return Pt.get(`/web/v1/sites/hostnames/${o}`)}var $t=class extends Ct{};var Rr=b("DocumentLoader"),Xe=b("remote:verify"),ke=class o{constructor(t,e){this.parser=t;this.settings=e;l(this,"canvasTreeVersion",0);l(this,"chunkingHints");this.canvasTreeVersion=this.parser.version,this.chunkingHints=this.parser.getChunkingHints()}static async createPartialParser(t,e){if(typeof t=="string"){let r=new zt(t);return new o(r,e)}else{let r=new Ht(t);return new o(r,e)}}readFirstPage(){let t=!1,e=[];if(this.settings.activeNodeId&&(e.push(...this.parser.getPagesContainingId(this.settings.activeNodeId)),t=e.some(r=>M(this.parser.getShallowPage(r)))),!t){let r=Ft(this.parser.getShallowPages(),this.parser.getHomePageNodeID());e.push(r.id)}return Rr.debug("loadPartialDocument():",e),jt(this.parser,e,this.settings.treeServices)}getScopesToLoad(){return this.parser.getPagesToLoad()}getParsedPageById(t){return this.parser.getParsedPageById(t)}buildPage(t){if(!t)return;let e=[],r=Xe.isLoggingTraceMessages()?[]:void 0,n=O(t,this.parser.root.id,{extraChecksAndFixes:!0,errors:e,warnings:r});if(n&&Ee(n,e),e.length>0&&Xe.warn("errors loading server tree: "+e.join(`
`)),r&&r.length>0&&Xe.trace("warnings loading server tree: "+r.join(`
`)),!!n)return n}};var Qe=b("app");function Tn(o){return o.treeReflectsDocument?Ir(o.tree):null}function Ir(o){return o.toJS()}function Cn(o){function t(e){let{__class:r,width:n,height:i,top:s,bottom:a,left:d,right:c}=e,{children:h}=e;return h?(h=h.map(t),{__class:r,width:n,height:i,top:s,bottom:a,left:d,right:c,children:h}):e.styledText?{__class:r,width:n,height:i,top:s,bottom:a,left:d,right:c,text:e.styledText.blocks.map(u=>u.text)}:{__class:r,width:n,height:i,top:s,bottom:a,left:d,right:c}}return t(o.tree.toJS().root)}function Rn(o){let t,e=new XMLHttpRequest;e.open("GET",o.toString(),!1);try{e.send(),t=JSON.parse(e.responseText)}catch(r){Qe.error(`Retrieving document \u201C${o}\u201D failed. (${r})`)}return et(t)}function Kt(o){we.isTest||o.forEach(t=>{Qe.warn("[repaired]",t)})}function et(o){let t=[];try{let e=Ie(o,t);return Kt(t),e}catch(e){throw Kt(t),Qe.warn("tree failed to verify:",e),e}}var ce=class extends Error{constructor(){super("cancelled"),this.name="CancelledError"}},xe=class{constructor(t){this.requestIdleCallback=t;l(this,"resumePromiseResolve");l(this,"resumePromise");l(this,"backgroundMode",!1);l(this,"done",!1);l(this,"firstError");l(this,"debugStepListener")}debugResumeOneStep(){this.resume(),this.pause()}currentMode(){return this.backgroundMode?"slow":"fast"}isDone(){return!!this.firstError||this.done}isSuccess(){return!this.firstError&&this.done}isCancelled(){return!!this.firstError&&this.firstError instanceof ce}isError(){return!!this.firstError&&!(this.firstError instanceof ce)}getError(){return this.firstError}cancel(){this.isDone()||(this.firstError=new ce)}error(t){return this.isDone()||(this.firstError=t),t}pause(){this.firstError||this.resumePromise||(this.resumePromise=new Promise(t=>{this.resumePromiseResolve=t}))}resume(){let t=this.resumePromiseResolve;t&&(this.resumePromise=void 0,this.resumePromiseResolve=void 0,t())}isPaused(){return!!this.resumePromise}fast(){this.backgroundMode=!1}slow(){this.backgroundMode=!0}async run(t){f(!this.isDone(),"task is already done");try{await t()}catch(e){throw e instanceof Error?this.error(e):this.error(new Error(String(e??"Unknown Error")))}finally{this.done=!0}}async sleep(t){if(this.debugStepListener?.(),await ht(t),this.resumePromise&&await this.resumePromise,this.debugStepListener?.(),this.resumePromise&&await this.resumePromise,this.firstError)throw this.firstError}async yield(){if(this.debugStepListener?.(),this.resumePromise?await this.resumePromise:this.backgroundMode?await new Promise(t=>{this.requestIdleCallback?this.requestIdleCallback(t):typeof requestIdleCallback=="function"?requestIdleCallback(t):setTimeout(t,0)}):await Se(),this.resumePromise&&await this.resumePromise,this.debugStepListener?.(),this.resumePromise&&await this.resumePromise,this.firstError)throw this.firstError}};var S=b("DocumentLoader"),Ue=10,le=1e3;function z(o){return o<1024*.75?`${Math.round(o)}b`:o<1024*1024*.75?`${(o/1024).toFixed(2)}kb`:`${(o/1024/1024).toFixed(2)}Mb`}function C(o){return o<200?`${o.toFixed(1)}ms`:o<20*1e3?`${(o/1e3).toFixed(3)}s`:`${Math.round(o/1e3)}s`}var H=class extends Ot{constructor(e,r,n){super();this.treeVersion=e;this.documentURL=r;this.settings=n;l(this,"scheduler");l(this,"retryCount",0);l(this,"scopesToLoad",new Set);l(this,"prioritizedScopeIds",new Set);l(this,"currentLoadingScope");l(this,"partialParser");l(this,"canvasTreeVersion",0);l(this,"documentSize",0);l(this,"loadedFirstScope",!1);l(this,"loadingDuration",0);l(this,"parsingDuration",0);l(this,"debugPaused",!1);l(this,"loadingScopesPaused",!1);l(this,"loadAllDataPriority",0);l(this,"updatePauseResumeState",()=>{if(!this.loadedFirstScope){this.scheduler.fast(),this.scheduler.resume();return}let e=this.loadAllDataPriority>0||this.prioritizedScopeIds.size>0,r=this.loadingScopesPaused||this.debugPaused;e?this.scheduler.fast():this.scheduler.slow(),e||!r||this.scopesToLoad.size<=0?this.scheduler.resume():this.scheduler.pause()});l(this,"tree");l(this,"loadCallbacksPerScope",new Map);l(this,"addedByDiff",new Set);l(this,"removedByDiff",new Set);this.scheduler=new xe(n.requestIdleCallback),S.debug("new:",this.treeVersion,this.documentURL)}pauseLoadingScopes(){this.loadingScopesPaused||(this.loadingScopesPaused=!0,S.debug("pauseLoadingScopes"),this.updatePauseResumeState())}resumeLoadingScopes(){this.loadingScopesPaused&&(this.loadingScopesPaused=!1,S.debug("resumeLoadingScopes"),this.updatePauseResumeState())}prioritizeLoadingAllData(e){let r="preload"in e&&e.preload;if(r&&B.isOn("debugEditWhileNeverLoadingRest"))return()=>{};let n=performance.now(),i=this.numberOfScopesToLoad();this.loadAllDataPriority=Math.max(1,this.loadAllDataPriority+1),S.debug("prioritizeLoadingScopes:",this.loadAllDataPriority),this.updatePauseResumeState();let s=r||"doNotTrack"in e&&e.doNotTrack,a=!1,d=s?void 0:this.afterAllDataLoaded(()=>{if(a)return;f("operationName"in e,"operationName is required");let h=performance.now()-n;Rt("fulltree_force_load",{operationName:e.operationName,durationMs:Math.round(h),background:e.operationInBackground,shallowScopesCount:i})});return()=>{a||(a=!0,d?.(),this.stopPrioritizingLoadingAllData())}}stopPrioritizingLoadingAllData(){this.loadAllDataPriority-=1,S.debug("stopPrioritizingLoadingScopes:",this.loadAllDataPriority),this.updatePauseResumeState()}debugPause(){this.debugPaused||(this.debugPaused=!0,S.debug("debugPause"),this.updatePauseResumeState())}debugResume(){this.debugPaused&&(this.debugPaused=!1,S.debug("debugResume"),this.updatePauseResumeState())}isDebugPaused(){return this.debugPaused}afterAllDataLoaded(e){let r=this.scopesToLoad.size===0;if(e){if(r){let n=!1;return queueMicrotask(()=>{n||e()}),()=>{n=!0}}return this.once("loadedAllData",e),()=>{this.off("loadedAllData",e)}}return r?Promise.resolve():new Promise(n=>{this.once("loadedAllData",n)})}async start(){await this.scheduler.run(async()=>{S.debug("start"),I("parsingInit"),this.updatePauseResumeState();let e=performance.now(),r=await this.loadData();if(this.loadingDuration=performance.now()-e,await this.scheduler.yield(),!this.settings.partialParsing||typeof r=="string"&&!Bt(r))return this.parseFullDocumentSync(r);let n=await this.loadDocumentVersion(r);for(await this.scheduler.yield(),this.tree=await this.loadFirstTree(n),this.loadedFirstScope=!0,this.updatePauseResumeState(),await this.scheduler.yield(),I("parsingResume");this.hasNextScopeToLoad();)await this.loadNextScopeAsync(n),await this.scheduler.yield();await this.emitWrapped(()=>{f(this.tree,"tree must have been set"),this.tree.setService("loader",void 0),this.emit("loadedAllData")}),S.debug("done",z(this.documentSize),"loading:",C(this.loadingDuration),"parsing:",C(this.parsingDuration))})}async loadData(){if(this.settings.loadedData)return this.settings.loadedData;S.debug("Document in cache is not up to date. Tree version:",this.treeVersion);let e=this.settings.initData,r=e?.version===this.treeVersion,n=e?.prefetchPromise;if(e&&delete e.prefetchPromise,r&&n){S.debug("loadData: prefetch");let d=await n;if(n.then(c=>c.duration).then(c=>{I("dataLoad",c)}),await this.scheduler.yield(),d.buffer){S.debug("loadData: prefetch bytes parser");let c=await d.buffer;return await this.scheduler.yield(),d.status<200||d.status>=300?this.handleErrorAndRetry(d.status,"Error loading project data"):new Uint8Array(c)}if(d.text){let c=await d.text;return await this.scheduler.yield(),d.status<200||d.status>=300?this.handleErrorAndRetry(d.status,c):c}}S.debug("loadData: fetch");let i;this.settings.refreshAccessToken&&(i=await this.settings.refreshAccessToken({}),await this.scheduler.yield());let s=await fetch(this.documentURL,i);await this.scheduler.yield();function a(d){if(!d.body)return!1;let c=new URLSearchParams(window.location.search).has("bytes"),h=document.cookie.includes("bytes-parser=true"),u=parseInt(d.headers.get("Uncompressed-Content-Length")??"0",10)>2e8;return c&&(document.cookie="bytes-parser=true; path=/;"),c||h||u}if(I("dataLoad"),s.status<200||s.status>=300){let d=await s.text();return this.handleErrorAndRetry(s.status,d)}if(a(s)){S.debug("loadData: using streaming parser");let d=await s.arrayBuffer();return new Uint8Array(d)}else{S.debug("loadData: using text parser");let d=await s.text();return await this.scheduler.yield(),d}}async handleErrorAndRetry(e,r){let n=!1;try{n=JSON.parse(r).retry}catch{}if(n&&this.retryCount<Ue)return S.debug("onErrorStatusLoaded, retry:",this.retryCount),await this.scheduler.sleep(this.retryCount*le+Math.random()*le),this.retryCount+=1,this.loadData();throw Error(n?"Too many retries":`Fetch Error: ${e} - ${r}`)}parseFullDocumentSync(e){if(typeof e!="string")throw new Error("Full document sync parsing requires string data, not ReadableStream");let r=performance.now();this.documentSize=e.length;let n=JSON.parse(e);if(!pt(n.version))throw Error("cannot read document version");if(this.canvasTreeVersion=n.version,S.debug("parseFullDocumentSync",this.canvasTreeVersion,z(this.documentSize),C(this.loadingDuration)),this.emit("loadedDocumentVersion",n.version),this.scheduler.isDone())return;let i=et(n);this.emit("loadedFirstData",i),!this.scheduler.isDone()&&(this.emit("loadedAllData"),this.parsingDuration+=performance.now()-r,I("parsingFirstPage"),S.debug("done",z(this.documentSize),"loading:",C(this.loadingDuration),"parsing:",C(this.parsingDuration)))}hasLoadedScope(e){let r=this.scopesToLoad.has(e),n=this.currentLoadingScope?.id===e;return!r&&!n}numberOfScopesToLoad(){return this.scopesToLoad.size}prioritizeLoadingScope(e,r){let n,i;if(typeof r=="function")this.addScopeLoadCallback(e,r);else if(r&&"onLoaded"in r)this.addScopeLoadCallback(e,r.onLoaded),i=r;else{let s=ut();n=s,this.addScopeLoadCallback(e,s.resolve),i=r}if(!(i?.preload&&B.isOn("debugEditWhileNeverLoadingRest")))return this.scopesToLoad.has(e)&&(this.prioritizedScopeIds.add(e),this.updatePauseResumeState(),this.addScopeLoadCallback(e,this.updatePauseResumeState)),n}nextScopeIdToLoad(){for(let r of this.prioritizedScopeIds)if(this.prioritizedScopeIds.delete(r),!!this.scopesToLoad.has(r))return this.scopesToLoad.delete(r),this.scheduler.fast(),r;let e=this.loadAllDataPriority>0;this.settings.loadInBackground&&!e?this.scheduler.slow():this.scheduler.fast();for(let r of this.scopesToLoad)return this.scopesToLoad.delete(r),r;throw Error("No next scope to load")}async loadDocumentVersion(e){let r=performance.now(),n=await ke.createPartialParser(e,this.settings);return typeof e=="string"?this.documentSize=e.length:this.documentSize=0,this.canvasTreeVersion=n.canvasTreeVersion,this.parsingDuration+=performance.now()-r,S.debug("loadDocumentVersion",this.canvasTreeVersion,typeof e=="string"?z(this.documentSize):"stream",C(this.loadingDuration)),await this.emitWrapped(()=>{if(this.scheduler.isDone())return;let i=performance.now();this.emit("loadedDocumentVersion",this.canvasTreeVersion),this.parsingDuration+=performance.now()-i}),this.partialParser=n,n}async loadFirstTree(e){let r=performance.now(),n=e.readFirstPage();this.scopesToLoad=e.getScopesToLoad();for(let i of this.scopesToLoad){let s=n.get(i);s&&(s.cache.isShallowLoad=!0)}return this.parsingDuration+=performance.now()-r,S.debug("loadFirstTree",C(this.parsingDuration)),await this.emitWrapped(()=>{if(this.scheduler.isDone())return;let i=performance.now();n.setService("loader",this),n.chunkingHints=e.chunkingHints,this.emit("loadedFirstData",n),I("parsingFirstPage"),this.parsingDuration+=performance.now()-i}),n}hasNextScopeToLoad(){return this.scopesToLoad.size>0}async loadNextScopeAsync(e){f(!this.currentLoadingScope,"already have a currently loading scope");let r=this.nextScopeIdToLoad();this.currentLoadingScope=new Ne(r,e);let n=await this.currentLoadingScope.run(this.scheduler);S.debug("loadScopeAsync:",r,C(n.duration),"scheduler mode:",this.scheduler.currentMode()),n.hasNode()&&await this.emitWrapped(()=>{if(this.scheduler.isDone())return;let i=performance.now(),s=n.take();this.currentLoadingScope=void 0,s&&(this.emit("loadedScope",s),this.parsingDuration+=n.duration+performance.now()-i,this.signalScopeLoadCallbacks(s.id))})}loadScope(e){if(f(this.partialParser,"loadScope before the parser is available"),this.currentLoadingScope?.id===e){let n=this.currentLoadingScope.force();return this.parsingDuration+=n.duration,this.currentLoadingScope=void 0,n.take()}if(this.prioritizedScopeIds.delete(e),!this.scopesToLoad.has(e))return;this.scopesToLoad.delete(e);let r=new Ne(e,this.partialParser).force();return this.parsingDuration+=r.duration,S.debug("loadScope:",e,C(r.duration)),this.signalScopeLoadCallbacks(e),r.take()}addScopeLoadCallback(e,r){if(!r)return;if(this.hasLoadedScope(e)){setTimeout(r);return}let n=this.loadCallbacksPerScope.get(e)??[];n.push(r),this.loadCallbacksPerScope.set(e,n)}signalScopeLoadCallbacks(e){setTimeout(()=>{let r=this.loadCallbacksPerScope.get(e);if(r){for(let n of r)n();this.loadCallbacksPerScope.delete(e)}})}async emitWrapped(e){this.settings.asyncEventWrapper?(await this.scheduler.yield(),await this.settings.asyncEventWrapper(e)):(await this.scheduler.yield(),e())}resetTreeForRecovery(e){e.setService("loader",this);for(let r of this.scopesToLoad){let n=e.get(r);n&&(n.cache.isShallowLoad=!0)}this.tree=e}async nodeIdsToLoad(){let e=performance.now(),r=new Set;if(!this.partialParser)return r;let n=performance.now();for(let i of this.scopesToLoad){performance.now()-n>50&&(await Se(),n=performance.now());let s=this.partialParser.getParsedPageById(i);Yt(r,s)}for(let i of this.addedByDiff)r.add(i);for(let i of this.removedByDiff)r.delete(i);return S.debug("nodeIdsToLoad",r.size,C(performance.now()-e)),r}addNodeChanges(e){for(let r of e){let n=r.id;r.added?(this.addedByDiff.add(n),this.removedByDiff.delete(n)):r.removed&&(this.addedByDiff.delete(n),this.removedByDiff.add(n))}}};function Yt(o,t){if(t&&(o.add(t.id),!!t.children))for(let e of t.children)Yt(o,e)}var W=class{constructor(t,e){this.node=t;this.duration=e}hasNode(){return!!this.node}take(){let t=this.node;return this.node=void 0,t}},Ne=class{constructor(t,e){this.id=t;this.parser=e;l(this,"data");l(this,"loadedScope")}async run(t){if(this.loadedScope)return this.loadedScope;let e=performance.now();this.data=this.parser.getParsedPageById(this.id);let r=performance.now()-e;if(await t.yield(),this.loadedScope)return this.loadedScope;let n=performance.now(),i=this.parser.buildPage(this.data);return i&&(i.cache.isShallowLoad=!1),this.loadedScope=new W(i,r+performance.now()-n),this.loadedScope}force(){if(this.loadedScope)return this.loadedScope;let t=performance.now();this.data||(this.data=this.parser.getParsedPageById(this.id));let e=this.parser.buildPage(this.data);return e&&(e.cache.isShallowLoad=!1),this.loadedScope=new W(e,performance.now()-t),this.loadedScope}};var V=b("tree:timeline"),Er=6e4,kr=6e4,tt=class{constructor(t){this.nodeChangesBuffers=t;l(this,"changes",new Map);this.nodeChangesBuffers.add(this)}trackChange(t,e){let r=this.changes.get(t);if(r){e&&r.push(e);return}this.changes.set(t,e?[e]:[])}read(){let t=this.changes;return this.changes=new Map,t}clear(){this.changes=new Map}dispose(){this.nodeChangesBuffers.delete(this)}},Ae=class{constructor(t,e,r=[],n=!1,i=!1){this.tree=t;this.changes=e;this.editReasons=r;this.wasRebase=n;this.wasCrdtRemote=i;l(this,"wasScopeInsert",!1);l(this,"version",0);l(this,"timestamp",performance.now())}toDebugData(){return{version:this.version,changes:this.changes,editReasons:this.editReasons,wasScopeInsert:this.wasScopeInsert,wasRebase:this.wasRebase,wasCrdtRemote:this.wasCrdtRemote}}},Le=class{constructor(){l(this,"idToChanges",new Map)}getChanges(){return Array.from(this.idToChanges.values())}addChanges(t){if(t)for(let e of t){let r=this.idToChanges.get(e.id);r||(r={id:e.id,to:{}},this.idToChanges.set(e.id,r)),Ye(r,e)}}},Gt=class{constructor(t,e){l(this,"tree");l(this,"entries");l(this,"latestReversibleNodeChanges",null);l(this,"enableAddRemoveOptimizations",!0);l(this,"trimmed",0);l(this,"isPartialLoading",!1);l(this,"internalRemoteTreeIndex",0);l(this,"inErrorRecovery",!1);l(this,"nodeChangesBuffers",new Set);l(this,"legacyMode",!1);l(this,"remoteTreeVersion",0);l(this,"recentEditReasons",[]);l(this,"flagsForNextCommit");l(this,"onlineStartTime",0);l(this,"validationEnabled",B.isOn("remoteDocumentSyncValidation")&&!0);l(this,"extraChangesForNextCommit");l(this,"resetTime",0);l(this,"epoch",0);this.reset(t,e)}get length(){return this.entries.length+this.trimmed}get localTreeIndex(){return this.length-1}get remoteTreeIndex(){return this.internalRemoteTreeIndex}incrementRemoteTreeIndex(t){this.internalRemoteTreeIndex+=t}setOnline(t){this.online!==t&&(this.onlineStartTime=t?performance.now():0)}get online(){return this.onlineStartTime!==0}setFlagsForNextCommit(t){this.flagsForNextCommit=t}validateUpdatesAreSentToServer(){if(!this.validationEnabled||!this.online)return;let t=performance.now();if(t-this.onlineStartTime<kr)return;let r=this.getOldestLocalEntry();if(!r)return;let n=t-r.timestamp;f(n<Er,"Local changes not been processed in a while")}setExtraChangesForNextCommit(t){this.extraChangesForNextCommit=t}recordEditReasons(t){t&&this.recentEditReasons.push(t)}trackChange(t,e=null){for(let r of this.nodeChangesBuffers)r.trackChange(t,e)}getTreeForVersion(t){if(!this.isPartialLoading)return It(this.entries,e=>e.version===t)?.tree}addEntry(t,e,r=[],n=!1,i=!1){let s=new Ae(t,e,r,n,i);return this.entries.push(s),this.tree=t,s}getLastEntry(){let t=this.entries[this.entries.length-1];return f(t,"Timeline has no entries"),t}getOldestLocalEntry(){return this.getEntry(this.remoteTreeIndex+1)}getEntry(t){return this.entries[t]}reset(t,e){if(this.resetTime=performance.now(),this.inErrorRecovery&&t===this.tree){V.debug("reset for error recovery..."),this.inErrorRecovery=!1,this.invalidateAllCursors(),this.clearNodeChangesReader();return}V.debug("reset with tree:",t.root.id,"size:",t.size()),this.entries=[],this.addEntry(t,e?.initialChanges??[],["load"]),this.recentEditReasons=[],this.flagsForNextCommit=void 0,this.extraChangesForNextCommit=void 0,this.latestReversibleNodeChanges=null,this.trimmed=0,this.internalRemoteTreeIndex=0,this.isPartialLoading=!!e?.isLoading,this.invalidateAllCursors(),this.clearNodeChangesReader()}invalidateAllCursors(){this.epoch+=1}openNodeChangesReader(){return new tt(this.nodeChangesBuffers)}clearNodeChangesReader(){for(let t of this.nodeChangesBuffers)t.clear()}applyFlagsToChange(t){t&&this.flagsForNextCommit&&(this.flagsForNextCommit.ignoreInUndo&&(t.ignoreInUndo=!0),this.flagsForNextCommit.ignoreInCodeGeneration&&(t.ignoreInCodeGeneration=!0))}commitLocalTree(){this.validateUpdatesAreSentToServer();let t=this.getLastEntry();f(this.tree===t.tree,"tree out of sync");let e={};this.tree=this.tree.commit((n,i)=>{if(!n&&!i)return;let s=Ce(n,i);if(this.applyFlagsToChange(s),this.trackChange(n?.id??i.id,s),s){if(s.to.parentid&&s.to.parentid!==s.from?.parentid){let d=this.tree.getScopeNodeAtStartFor(n),c=this.tree.getScopeNodeFor(i);d&&d?.id!==c?.id&&(s.previousScope=d.id)}e[s.id]=s}let a=[];At(a,n,i);for(let d of a)this.applyFlagsToChange(d),this.trackChange(d.id,d),e[d.id]=d}),this.latestReversibleNodeChanges=Object.values(e);let r=this.latestReversibleNodeChanges;if(this.extraChangesForNextCommit){r=[...r];for(let n of this.extraChangesForNextCommit)this.applyFlagsToChange(n),this.trackChange(n.id,n),r.push(n)}return this.flagsForNextCommit=void 0,this.extraChangesForNextCommit=void 0,V.debug("commit local tree:",r.length,this.recentEditReasons),r.length>0?(f(t.tree!==this.tree,"must be a new tree"),t.tree.releaseMemory(),this.entries.push(new Ae(this.tree,r,this.recentEditReasons))):this.tree!==t.tree&&(t.tree.releaseMemory(),t.tree=this.tree),this.recentEditReasons=[],f(this.tree===this.getLastEntry().tree),this.tree}getLatestChangesForUndo(){return this.latestReversibleNodeChanges}getChangeTrackingCursor(){let t=this.remoteTreeIndex,e=this.localTreeIndex;return{remoteTree:t,localTree:e,timeline:this,tree:this.tree,epoch:this.epoch}}invalidatedByLoadCompletedDocument(t){return!(!t||this.trimmed>0||t.timeline!==this||t.epoch+1!==this.epoch||t.remoteTree+1!==this.remoteTreeIndex)}fetchForwardChanges(t){if(!t||t.epoch!==this.epoch||t.tree.lineage!==this.tree.lineage||t.tree.root.id!==this.tree.root.id||t.timeline!==this||t.localTree>0&&t.localTree<=this.trimmed||t.remoteTree>0&&t.remoteTree<=this.trimmed||this.remoteTreeIndex>0&&this.trimmed>0&&t.remoteTree===0)return;let e=t.localTree;if(this.remoteTreeIndex>0)for(e=t.remoteTree-1;e<t.localTree&&!this.entries[e+1-this.trimmed]?.wasRebase;)e+=1;f(e-this.trimmed>=0,"buffer cut too close to remoteTree"),f(e<=t.localTree,"startIndex incorrectly calculated");let r=this.localTreeIndex;f(e<=r,"bad change tracking cursor");let n=t.tree;return t.remoteTree=this.remoteTreeIndex,t.localTree=r,t.tree=this.tree,this.computeForwardChanges(e,r,n)}computeForwardChanges(t,e,r){if(t>=e)return[];let n={};for(let s=t+1;s<=e;s++){let a=this.entries[s-this.trimmed];if(!a.wasCrdtRemote)for(let d of a.changes){let c=d.id,h=n[c];h||(h=n[c]={id:c,to:{}});let u=h.added;Ye(h,d),!r&&u&&h.removed&&this.enableAddRemoveOptimizations&&delete n[c]}}let i=r??this.entries[t-this.trimmed]?.tree;if(!i)throw new Error(`${t} - ${this.trimmed}`);return Object.values(n).filter(s=>{if(s.removed)return s.to={},!0;let a=i.getNodeAtStart(s.id);if(a&&this.enableAddRemoveOptimizations)for(let[u,p]of Object.entries(s.to))oe(a[u],p)&&delete s.to[u];if(s.added||Object.keys(s.to).length>0)return!0;let d=s.toChildren;if(!d)return!1;if(!a)return!0;i.beginAllowPartialScopeAccess();let c=a.children;if(i.endAllowPartialScopeAccess(),!c||!this.enableAddRemoveOptimizations)return!0;let h=c.length;if(h!==d.length)return!0;for(let u=0;u<h;u++)if(c[u].id!==d[u])return!0;return!1})}getEditReasons(t,e){let r=[],n="";for(let i=t+1;i<=e;i++){let s=this.entries[i-this.trimmed].editReasons;for(let a of s)a&&n!==a&&(n=a,r.push(a))}return r.join(" ")}getChangesBetweenEntries(t,e){f(t<e,"inconsistency in getting local changes to send");let r=this.computeForwardChanges(t,e),n=this.getEditReasons(t,e);return{count:e-t,changes:r,reasons:n}}debugOverwriteCurrentTree(t){V.debug("recover with tree:",t.root.id),this.tree=t,this.getLastEntry().tree=t}resetTreesForRecovery(t,e){V.info("reset trees for recovery, remote:",this.remoteTreeIndex,"local:",this.localTreeIndex,"changes already sent:",e);let r=this.entries[t]?.tree;f(r,"unable to get remote tree");let n=r.getService("loader"),i=r.lineage.editHooks,s=[];try{r=Ie(JSON.parse(JSON.stringify(r.toJS())),s)}catch(d){if(d instanceof RangeError&&d.message.includes("Invalid string length"))V.warn("[recovery] Tree too large for JSON serialization, using original tree",{error:d.message,treeSize:r.size()}),s.push("Recovery skipped: tree too large for serialization");else throw d}n&&(n.resetTreeForRecovery(r),f(r.getService("loader")===n,"tree must have the same loader")),i&&(r.lineage.editHooks=i),s.length>0&&V.warn("[recovery] encountered errors while reloading the tree:",s),this.entries[t].tree=r,this.entries.length=t+e+1;let a=r;for(let d=t+1;d<this.entries.length;d++){let c=this.entries[d];N(r,c.changes),r=r.commitDiffs(),c.tree=r,r!==a&&(a.releaseMemory(),a=r)}return this.inErrorRecovery=!0,this.tree=r,r}saveTimelineDataForRecovery(){if(window.localStorage)try{let t=`debugTimelineAtRecovery-${Math.floor(Math.random()*100)}`,e={date:new Date().toString(),entries:this.entries.map(r=>r.toDebugData())};window.localStorage.setItem(t,JSON.stringify(e))}catch(t){V.warn("failed to store timeline in localStorage:",t)}}};var Jt=class{constructor(){l(this,"undoBuffer",[]);l(this,"redoBuffer",[]);l(this,"undoGroup",[]);l(this,"scheduledEndUndoGroup")}canUndo(){return this.undoBuffer.length>0}peekUndo(){return this.undoBuffer.at(-1)}undo(t,e){let r=this.undoBuffer.pop();if(J(r))return;Ze(t,r.changes),this.redoBuffer.push({...r,...e});let n=this.undoBuffer.length;return this.undoGroup.forEach((i,s)=>{this.undoGroup[s]=Math.min(i,n)}),r}canRedo(){return this.redoBuffer.length>0}peekRedo(){return this.redoBuffer.at(-1)}redo(t,e){let r=this.redoBuffer.pop();if(!J(r))return N(t,r.changes),this.undoBuffer.push({...r,...e}),r}beginUndoGroup(){this.undoGroup.push(this.undoBuffer.length)}discardUndoGroup(t){let e=this.undoGroup.pop();if(J(e)||e>=this.undoBuffer.length)return;let r=this.undoBuffer.splice(e),n=Ge(r);return Ze(t,n),r[0]}scheduleEndUndoGroup(){let t=this.undoGroup.pop();J(t)||t>=this.undoBuffer.length||(this.scheduledEndUndoGroup=t)}processScheduledEndUndoGroup(t){let e=this.scheduledEndUndoGroup;if(this.scheduledEndUndoGroup=void 0,J(e)||e>=this.undoBuffer.length)return;let r=this.undoBuffer.splice(e),n=Ge(r);this.undoBuffer.push({changes:n,...t})}clearUndoStack(){this.undoBuffer.length=0,this.redoBuffer.length=0,this.undoGroup.length=0,this.scheduledEndUndoGroup=void 0}addUndoEntry(t){this.undoBuffer.push(t),this.redoBuffer.length=0}getUndoBufferSize(){return this.undoBuffer.length}};var T=Tr(Cr());var xr=0,De=class{constructor(){l(this,"id",++xr);l(this,"currentRtt",NaN);l(this,"rtts",[]);l(this,"rttIndex",0);l(this,"pending",Array.from(Array(128),()=>({type:"",time:0})));l(this,"start",0);l(this,"end",0);l(this,"overflow",0);l(this,"lastSendTime",0);l(this,"bytesSent",0);l(this,"bytesReceived",0)}read(){let{bytesSent:t,bytesReceived:e,id:r}=this;return this.bytesSent=0,this.bytesReceived=0,[t,e,this.rtt(),r]}computeRtt(){let t=this.rtts.length;if(t===0){this.currentRtt=NaN;return}let e=0;for(let r of this.rtts)e+=r;this.currentRtt=e/t}lastSend(){return this.lastSendTime}rtt(){return Number.isNaN(this.currentRtt)&&this.computeRtt(),Math.max(this.currentRtt||0,this.pendingRtt())}pendingRtt(){return this.start===this.end?0:performance.now()-this.pending[this.start].time}pendingCount(t){if(!t)return this.start>this.end?128-this.start+this.end:this.end-this.start;let e=0;for(let r=this.start;r!==this.end;r=r+1&127)this.pending[r].type===t&&e++;return e}sent(t,e){this.bytesSent+=e.length,this.end===(this.start===0?127:this.start-1)&&(this.start=this.start+1&127,this.overflow++);let r=this.pending[this.end];r.type=t,r.time=performance.now(),this.end=this.end+1&127,this.lastSendTime=r.time}received(t){this.bytesReceived+=t.length}acked(){if(this.start===this.end){console.warn("Called SocketStats.acked() with empty buffer");return}if(this.overflow>0){this.overflow--;return}let t=this.pending[this.start],e=performance.now()-t.time;this.rtts.length<32?this.rtts.push(e):(this.rtts[this.rttIndex]=e,this.rttIndex=this.rttIndex+1&31),this.start=this.start+1&127,this.currentRtt=NaN}};var P=b("remote:socket"),Nr=27;function Ur(o){switch(o){case"AccessDenied":case"ClientNeedsUpdate":case"ClientTooNew":case"DocumentNotFound":case"UnsupportedSchema":case"Maintenance":case"UnknownPermanentError":case"ClientSidePermanentError":return!1;case"ReconnectToNewServer":case"UnknownRecoverableError":case"ClientSideRecoverableError":return!0;default:return ye(o)}}function ai({url:o,documentConnection:t,tunnel:e=null}){let r=(0,T.useRef)(null),n=(0,T.useRef)(!0),i=(0,T.useRef)({onConnect:new Set,onDisconnect:new Set,onMessage:new Set}),s=(0,T.useRef)(o),a=(0,T.useRef)(!0),d=(0,T.useRef)(void 0);function c(){d.current!==void 0&&(window.clearTimeout(d.current),d.current=void 0)}let h=(0,T.useCallback)(()=>{a.current=!1;let g=r.current;g&&g.ws.readyState<WebSocket.CLOSING&&(g.clientClosed=!0,g.ws.close())},[]),u=(0,T.useCallback)(()=>{if(c(),!a.current||r.current)return;function g(R){d.current===void 0&&(d.current=window.setTimeout(()=>{d.current=void 0,navigator.onLine&&!document.hidden&&u()},R))}let y=new URL(s.current);if(y.searchParams.set("v",Nr.toString()),y.searchParams.set("tunnel",e||""),Wt()&&y.searchParams.set("mode","crdt"),t.treeSchema<=0)return;y.searchParams.set("treeSchema",t.treeSchema.toString()),y.searchParams.set("treeVersion",t.treeVersion.toString()),P.debug("connecting to",y.href);let j=performance.now(),k=new WebSocket(y.href),x=new De,F={ws:k,stats:x,clientClosed:!1};t.setSocketStats(x);let _=0;k.addEventListener("open",()=>{P.debug("open"),_=window.setInterval(()=>{if(performance.now()-x.lastSend()<1e3||x.pendingCount("ping")>1||k.readyState!==WebSocket.OPEN)return;let R="ping {}";k.send(R),x.sent("ping",R)},1e3);for(let R of i.current.onConnect)try{R(n.current)}catch(U){P.warn("Error in onConnect handler:",U)}n.current=!1}),k.addEventListener("close",R=>{let U=Lr(R);if(P.debug("close:",U,"clientClosed:",F.clientClosed,R),_!==0&&(clearInterval(_),_=0),r.current===F){Ur(U)||(a.current=!1);for(let L of i.current.onDisconnect)try{L(U)}catch(We){P.warn("Error in onDisconnect handler:",We)}if(r.current=null,a.current){let L=1e3;U==="ReconnectToNewServer"?L=50:performance.now()-j<5e3&&(L=5e3),g(L)}}}),k.addEventListener("message",R=>{try{let U=R.data;x.received(U);let L=Dr(U);if(L.type==="ack"){x.acked();return}else L.type==="redirect"&&(s.current=L.value.url);for(let We of i.current.onMessage)try{We(L)}catch(vr){P.warn("Error in onMessage handler:",vr)}}catch(U){P.warn("Error receiving:",U)}}),r.current=F},[t]);(0,T.useEffect)(()=>{u()},[u]);let p=(0,T.useCallback)(({online:g,visible:y})=>{g&&y?u():c()},[u]);return Ar(p),(0,T.useMemo)(()=>({getSocketStats(){return r.current?.stats},connect(){a.current=!0,u()},disconnect(){h()},onConnect(g){return i.current.onConnect.add(g),()=>{i.current.onConnect.delete(g)}},onDisconnect(g){return i.current.onDisconnect.add(g),()=>{i.current.onDisconnect.delete(g)}},onMessage(g){return i.current.onMessage.add(g),()=>{i.current.onMessage.delete(g)}},send(g){if(!r.current||r.current.ws.readyState!==1){g.type!=="state"&&P.warn("Dropping",g.type,"message.");return}try{let y=`${g.type} ${JSON.stringify(g.value)}`;r.current.ws.send(y),r.current.stats.sent(g.type,y)}catch(y){P.warn("Error sending",g.type,"message:",y)}}}),[u,h])}function Ar(o){(0,T.useEffect)(()=>{document.addEventListener("visibilitychange",t),window.addEventListener("online",t),window.addEventListener("offline",t);function t(){o({online:navigator.onLine,visible:!document.hidden})}return()=>{document.removeEventListener("visibilitychange",t),window.removeEventListener("online",t),window.removeEventListener("offline",t)}},[o])}function Lr(o){switch(o.reason){case"ERR_RECONNECT_TO_NEW_SERVER":return"ReconnectToNewServer";case"ERR_ACCESS_DENIED":return"AccessDenied";case"ERR_CLIENT_NEEDS_UPDATE":return"ClientNeedsUpdate";case"ERR_DOCUMENT_NOT_FOUND":return"DocumentNotFound";case"ERR_UNSUPPORTED_SCHEMA_VERSION":return"UnsupportedSchema";case"ERR_MAINTENANCE":return"Maintenance";case"ERR_INVALID_OPERATION":return"ClientSidePermanentError";case"ERR_UNKNOWN":return"UnknownPermanentError"}return o.code===1011?"ClientNeedsUpdate":"UnknownRecoverableError"}function Dr(o){let t=o.indexOf(" "),e=o.indexOf(" ",t+1);f(t>=0&&e>=0,"Invalid data");let r=o.substring(0,t),n=o.substring(t+1,e),i=o.substring(e+1),s=JSON.parse(i);return{id:r,type:n,value:s}}var he=class{constructor(){l(this,"cache",new Map)}set(t,e,r){let n=this.cache.get(t);n||(n=new Map,this.cache.set(t,n)),n.set(e,r)}getSubMap(t){return this.cache.get(t)}get(t,e){return this.cache.get(t)?.get(e)}clear(){this.cache.clear()}};var Pe=class{constructor(t){l(this,"seqs",[]);l(this,"idxs",[]);l(this,"maxSize");this.maxSize=t?.maxSize}clear(){this.seqs=[],this.idxs=[]}get(t){let e=this.seqs.length;if(e===0)return 0;let r=Zt(this.seqs,t);return r<e&&this.seqs[r]===t?this.idxs[r]:0}add(t,e){if(this.maxSize&&this.seqs.length>=this.maxSize&&this.seqs[0]>t)return;let i=Zt(this.seqs,t);if(i<this.seqs.length&&this.seqs[i]===t){e<this.idxs[i]&&(this.idxs[i]=e,this.propagateLeftFrom(i));return}this.seqs.splice(i,0,t),this.idxs.splice(i,0,e),i+1<this.idxs.length&&(this.idxs[i]=Math.min(this.idxs[i],this.idxs[i+1])),this.propagateLeftFrom(i),this.evict()}evict(){if(this.maxSize){let t=this.seqs.length-this.maxSize;t>0&&(this.seqs.splice(0,t),this.idxs.splice(0,t))}}propagateLeftFrom(t){let e=this.idxs[t];for(let r=t-1;r>=0&&!(this.idxs[r]<=e);r--)this.idxs[r]=e}__snapshot(){return this.seqs.map((t,e)=>({seq:t,idx:this.idxs[e]}))}};function Zt(o,t){let e=0,r=o.length;for(;e<r;){let n=e+r>>>1;o[n]<t?e=n+1:r=n}return e}var ue=class{constructor(t,e){this.capacity=t;l(this,"buffer");l(this,"length",0);e?(this.buffer=e.buffer,this.length=e.length,f(this.buffer.length===this.capacity,"Buffer capacity mismatch:",this.buffer.length,"!=",this.capacity)):this.buffer=new Float64Array(t)}push(t){this.buffer[this.length]=t,this.length+=1}clone(){return this.buffer.subarray(0,this.length)}},fe=class{constructor(t){this.bucketSize=t;l(this,"buckets",[]);l(this,"_length",0);l(this,"bucketShift");l(this,"bucketMask");f((t&t-1)===0,`Bucket size must be a power of 2, got: ${t}`),this.bucketShift=Math.log2(t),this.bucketMask=t-1}add(t){let e=this.buckets[this.buckets.length-1];(!e||e.length>=e.capacity)&&(e=new ue(this.bucketSize),this.buckets.push(e)),e.push(t);let r=this._length;return this._length+=1,r}get(t){let e=t>>this.bucketShift,r=t&this.bucketMask;return this.buckets[e]?.buffer[r]}get length(){return this._length}slice(t,e){t<0&&(t=this.length+t),e<0&&(e=this.length+e);let r=t>>this.bucketShift,n=e>>this.bucketShift,i=Math.min(this.length,e)-t;if(i<=0)return[];let s=Array.from({length:i}),a=0,d=t&this.bucketMask,c=this.buckets[r];if(r===n){let p=e&this.bucketMask;for(let m=d;m<p;++m)s[a++]=c.buffer[m];return s}for(let p=d;p<this.bucketSize;++p)s[a++]=c.buffer[p];for(let p=r+1;p<n;++p){let m=this.buckets[p];for(let g=0;g<m.length;++g)s[a++]=m.buffer[g]}let h=e&this.bucketMask,u=this.buckets[n];for(let p=0;p<h;++p)s[a++]=u.buffer[p];return s}toState(){return new Float64Array(this.slice(0,this.length))}fromState(t){let e=t;this._length=e.length;let r=0;for(r=0;r<e.length-this.bucketSize;r+=this.bucketSize){let i=e.subarray(r,r+this.bucketSize);this.buckets.push(new ue(this.bucketSize,{buffer:i,length:i.length}))}let n=new ue(this.bucketSize);for(;r<e.length;++r)n.push(e[r]);this.buckets.push(n)}};var ee=class{constructor(t=1024){l(this,"uniques",[]);l(this,"indices");l(this,"count",0);l(this,"lookup");l(this,"cursor",0);this.indices=new Uint32Array(t)}ensureCapacity(t){if(t<=this.indices.length)return;let e=this.indices.length||1;for(;e<t;)e<<=1;let r=new Uint32Array(e);r.set(this.indices),this.indices=r}hydrateThrough(t){for(this.lookup||(this.lookup=new Map);this.cursor<=t;++this.cursor){let e=this.uniques[this.cursor];this.lookup.set(e,this.cursor)}}indexOfExisting(t){if(this.lookup?.has(t))return this.lookup.get(t);for(;this.cursor<this.uniques.length;++this.cursor){let e=this.uniques[this.cursor];if(this.lookup??=new Map,this.lookup.set(e,this.cursor),Object.is(e,t))return this.cursor}}add(t){let e=this.indexOfExisting(t);e===void 0&&(e=this.uniques.length,this.uniques.push(t),this.lookup??=new Map,this.lookup.set(t,e),this.cursor=this.uniques.length);let r=this.count;return this.ensureCapacity(r+1),this.indices[r]=e,this.count=r+1,r}get(t){if(t<0||t>=this.count)throw RangeError("index out of bounds");return this.uniques[this.indices[t]]}slice(t,e){let r=Math.max(0,e-t),n=new Array(r);for(let i=0;i<r;++i)n[i]=this.uniques[this.indices[t+i]];return n}get length(){return this.count}toState(){return[JSON.stringify(this.uniques),this.indices.subarray(0,this.count)]}fromState(t){let[e,r]=t;this.uniques=JSON.parse(e),this.indices=new Uint32Array(r),this.count=this.indices.length,this.lookup=void 0,this.cursor=this.uniques.length}rehydrate(){this.cursor<this.uniques.length&&this.hydrateThrough(this.uniques.length-1)}};function Xt(o){switch(typeof o){case"string":return 1;case"number":return o===0?Object.is(o,-0)?15:14:2;case"boolean":return 3;case"undefined":return 4;case"object":return o===null?5:o instanceof Uint8Array?8:o instanceof Uint16Array?9:o instanceof Uint32Array?10:o instanceof Float32Array?12:o instanceof Float64Array?13:o instanceof BigUint64Array?11:Array.isArray(o)?6:7;default:throw Error(`Unknown type: ${o}`)}}var Fe=class{constructor(t){l(this,"buffer");l(this,"view");l(this,"offset");this.buffer=t??new Uint8Array(1024*1024),this.view=new DataView(this.buffer.buffer),this.offset=0}ensureCapacity(t){let e=this.offset+t;if(e>this.buffer.length){let r=this.buffer.length*2;for(;r<e;)r*=2;let n=new Uint8Array(r);n.set(this.buffer),this.buffer=n,this.view=new DataView(this.buffer.buffer)}}align(t){let e=this.offset+t-1&~(t-1);this.ensureCapacity(e-this.offset),this.offset=e}write(t){let e=Xt(t);switch(this.writeType(e),e){case 1:this.writeString(t);break;case 2:this.writeNumber(t);break;case 16:this.writeVarInt(t);break;case 17:this.writeVarUint(t);break;case 14:this.writeZero();break;case 15:this.writeZeroNegative();break;case 3:this.writeBoolean(t);break;case 4:this.writeUndefined();break;case 5:this.writeNull();break;case 6:this.writeArray(t);break;case 7:this.writeObject(t);break;case 8:this.writeUint8Array(t);break;case 9:this.writeUint16Array(t);break;case 10:this.writeUint32Array(t);break;case 12:this.writeFloat32Array(t);break;case 13:this.writeFloat64Array(t);break;case 11:this.writeBigUint64Array(t);break;default:throw Error(`Unknown type: ${e}`)}}writeUint8(t){return this.ensureCapacity(1),this.view.setUint8(this.offset,t),this.offset+=1,1}writeUint16(t){this.ensureCapacity(2),this.view.setUint16(this.offset,t,!0),this.offset+=2}writeUint32(t){this.ensureCapacity(4),this.view.setUint32(this.offset,t,!0),this.offset+=4}writeFloat32(t){this.ensureCapacity(4),this.view.setFloat32(this.offset,t,!0),this.offset+=4}writeFloat64(t){this.ensureCapacity(8),this.view.setFloat64(this.offset,t,!0),this.offset+=8}writeVarInt(t){let e=t>=0?t*2:-t*2-1;this.writeVarUint(e)}writeVarUint(t){let e=t;for(;e>=128;)this.writeUint8(e%128|128),e=Math.floor(e/128);this.writeUint8(e)}writeType(t){this.writeUint8(t)}writeString(t){let e=Or(t);this.writeVarUint(e.length),this.ensureCapacity(e.length),this.buffer.set(e,this.offset),this.offset+=e.length}writeNumber(t){this.writeFloat64(t)}writeBoolean(t){this.writeUint8(t?1:0)}writeUndefined(){}writeNull(){}writeZero(){}writeZeroNegative(){}writeArray(t){this.writeVarUint(t.length);for(let e of t)this.write(e)}writeObject(t){let e=Object.keys(t);this.writeVarUint(e.length);for(let r of e)this.writeString(r),this.write(t[r])}writeTypedArrayGeneric(t,e){this.writeVarUint(t.length),this.align(e);let r=t.length*e;this.ensureCapacity(r);let n=new Uint8Array(t.buffer,t.byteOffset,r);this.buffer.set(n,this.offset),this.offset+=r}writeUint8Array(t){this.writeTypedArrayGeneric(t,Uint8Array.BYTES_PER_ELEMENT)}writeUint16Array(t){this.writeTypedArrayGeneric(t,Uint16Array.BYTES_PER_ELEMENT)}writeUint32Array(t){this.writeTypedArrayGeneric(t,Uint32Array.BYTES_PER_ELEMENT)}writeFloat32Array(t){this.writeTypedArrayGeneric(t,Float32Array.BYTES_PER_ELEMENT)}writeFloat64Array(t){this.writeTypedArrayGeneric(t,Float64Array.BYTES_PER_ELEMENT)}writeBigUint64Array(t){this.writeTypedArrayGeneric(t,BigUint64Array.BYTES_PER_ELEMENT)}getBuffer(){return this.buffer.slice(0,this.offset)}},Oe=class{constructor(t){l(this,"buffer");l(this,"view");l(this,"offset");if(!(t instanceof Uint8Array))throw new Error(`Buffer is not a Uint8Array: ${t}`);this.buffer=t,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.offset=0}align(t){let e=(t-this.offset%t)%t;this.offset+=e}read(){let t=this.readType();switch(t){case 1:return this.readString();case 2:return this.readNumber();case 16:return this.readVarInt();case 17:return this.readVarUint();case 14:return 0;case 15:return-0;case 3:return this.readBoolean();case 4:return this.readUndefined();case 5:return this.readNull();case 6:return this.readArray();case 7:return this.readObject();case 8:return this.readUint8Array();case 9:return this.readUint16Array();case 10:return this.readUint32Array();case 12:return this.readFloat32Array();case 13:return this.readFloat64Array();case 11:return this.readBigUint64Array();default:throw Error(`Unknown type: ${t}`)}}readUint8(){let t=this.view.getUint8(this.offset);return this.offset+=1,t}readUint16(){let t=this.view.getUint16(this.offset,!0);return this.offset+=2,t}readUint32(){let t=this.view.getUint32(this.offset,!0);return this.offset+=4,t}readFloat32(){let t=this.view.getFloat32(this.offset,!0);return this.offset+=4,t}readFloat64(){let t=this.view.getFloat64(this.offset,!0);return this.offset+=8,t}readVarInt(){let t=this.readVarUint();return t%2===0?t/2:-Math.floor(t/2)-1}readVarUint(){let t=0,e=0;for(;;){let r=this.readUint8();if(t+=(r&127)*2**e,(r&128)===0)break;if(e+=7,e>53)throw new Error("VarUint is too big")}return t}readType(){return this.readUint8()}readString(){let t=this.readVarUint(),e=this.buffer.subarray(this.offset,this.offset+t);return this.offset+=t,Mr(e)}readNumber(){return this.readFloat64()}readBoolean(){return this.readUint8()===1}readUndefined(){}readNull(){return null}readArray(){let t=this.readVarUint(),e=new Array(t);for(let r=0;r<t;r++)e[r]=this.read();return e}readObject(){let t=this.readVarUint(),e={};for(let r=0;r<t;r++){let n=this.readString();e[n]=this.read()}return e}readTypedArray(t){let e=this.readVarUint(),r=t.BYTES_PER_ELEMENT;this.align(r);let n=this.offset+this.buffer.byteOffset,i=e*r;if(n%r!==0){let s=new ArrayBuffer(i);return new Uint8Array(s).set(new Uint8Array(this.buffer.buffer,n,i)),this.offset+=i,new t(s,0,e)}return this.offset+=i,new t(this.buffer.buffer,n,e)}readUint8Array(){return this.readTypedArray(Uint8Array)}readUint16Array(){return this.readTypedArray(Uint16Array)}readUint32Array(){return this.readTypedArray(Uint32Array)}readFloat32Array(){return this.readTypedArray(Float32Array)}readFloat64Array(){return this.readTypedArray(Float64Array)}readBigUint64Array(){return this.readTypedArray(BigUint64Array)}},Pr=new TextEncoder,Fr=new TextDecoder;function Or(o){return Pr.encode(o)}function Mr(o){return Fr.decode(o)}function rt(o){let t=new Fe;return t.write(o),t.getBuffer()}function nt(o){return new Oe(o).read()}var Qt=2**17,te=class{constructor(){l(this,"columns",{client:new fe(Qt),seq:new fe(Qt),id:new ee,key:new ee,value:new ee})}getRowInternal(t){return{client:this.columns.client.get(t),seq:this.columns.seq.get(t),id:this.columns.id.get(t),key:this.columns.key.get(t),value:this.columns.value.get(t)}}getRow(t){if(t<0||t>=this.columns.client.length)throw new Error("Index out of bounds");return this.getRowInternal(t)}getRows(t=0,e=this.columns.client.length){if(t<0||e>this.columns.client.length||t>e)throw new Error("Index out of bounds");let r=new Array(e-t);for(let n=t;n<e;n++)r[n-t]=this.getRowInternal(n);return r}toBuffer(){return rt([this.columns.client.toState(),this.columns.seq.toState(),this.columns.id.toState(),this.columns.key.toState(),this.columns.value.toState()])}fromBuffer(t){let[e,r,n,i,s]=nt(t);this.columns.client.fromState(e),this.columns.seq.fromState(r),this.columns.id.fromState(n),this.columns.key.fromState(i),this.columns.value.fromState(s)}get length(){return this.columns.client.length}};function it(o,t){let e=o.length,r=t.length,n=Array.from({length:e+1},()=>new Array(r+1).fill(0));for(let d=e-1;d>=0;--d)for(let c=r-1;c>=0;--c)o[d]===t[c]?n[d][c]=n[d+1][c+1]+1:n[d][c]=Math.max(n[d+1][c],n[d][c+1]);let i=[],s=0,a=0;for(;s<e&&a<r;)o[s]===t[a]?(s+=1,a+=1):n[s+1][a]>n[s][a+1]?(i.push({operation:"delete",index:s}),s+=1):(i.push({operation:"insert",index:a,value:t[a]}),a+=1);for(;s<e;)i.push({operation:"delete",index:s}),s+=1;for(;a<r;)i.push({operation:"insert",index:a,value:t[a]}),a+=1;return i}function st(o,t,e,r,n,i){let s=t-o;if(s<1e-8)return o+s/2;let a;if(r!==null&&r===e&&n!==null){let c=i-n;a=Math.min(.01*c,.5)}else a=.01+((e^i)>>>0)%100/100*.98;let d=o+s*a;return d<=o||d>=t?o+s/2:d}var rr=new ArrayBuffer(8),Vr=new Float64Array(rr),er=new Uint32Array(rr),qr=o=>(Vr[0]=o,[er[0]>>>0,er[1]>>>0]),tr=(o,t)=>o<<t|o>>>32-t,Ve=(o,t)=>{let e=Math.imul(t,3432918353);e=tr(e,15),e=Math.imul(e,461845907);let r=o^e;return r=tr(r,13),Math.imul(r,5)+3864292196>>>0},ot=o=>{let t=o;return t^=t>>>16,t=Math.imul(t,2246822507),t^=t>>>13,t=Math.imul(t,3266489909),(t^t>>>16)>>>0},Me=o=>{let t=0,e=0;for(;e+1<o.length;e+=2){let r=o.charCodeAt(e)|o.charCodeAt(e+1)<<16;t=Ve(t,r)}return e<o.length&&(t=Ve(t,o.charCodeAt(e))),ot(t^o.length)},jr=2097151,_r=o=>{let t=2654435769,e=2135587861,r=i=>{t=Ve(t,i),e=Ve(e,i^2915580697)},n=i=>{switch(typeof i){case"string":r(Me(i));break;case"number":{let[s,a]=qr(i);r(s),r(a)}break;case"boolean":r(i?1:0);break;case"undefined":r(2);break;case"symbol":r(Me(i.description??""));break;case"bigint":r(Number(i&0xffffffffn)),r(Number(i>>32n&0xffffffffn));break;case"function":r(Me(i.toString()));break;case"object":{if(i===null){r(7);break}if(Array.isArray(i)){let a=i.length;if(r(165),r(a),a>32){for(let c=0;c<8;++c)n(i[c]);for(let c=a-8;c<a;++c)n(i[c]);let d=(a-16)/16|0;for(let c=8;c<a-8;c+=d)n(i[c])}else for(let d=0;d<a;++d)n(i[d]);break}r(195);let s=0;for(let a in i){if(++s>32)break;r(Me(a)),n(i[a])}r(s);break}default:r(13)}};return n(o),t=ot(t),e=ot(e),(t&jr)*4294967296+e},at=_r;var re=o=>{let t=5381;for(let e=0;e<o.length;e++)t=(t<<5)+t+o.charCodeAt(e);return t&65535};function me(o){return typeof o=="object"&&o!==null}function Br(o,t){if(o.length!==t.length)return!1;let e=o.length;for(let r=0;r<e;r++)if(o[r]!==t[r])return!1;return!0}var v="$deleted",q="$keep",qe="$keep_value";function zr(o,t,e,r){return o===e?t>r:o>e}function Hr(o,t){return o.seq===t.seq?o.client-t.client:o.seq-t.seq}function dt(o){if(typeof o=="string"&&o.startsWith("arr("))return o.slice(4,-1)}function pe(o){if(typeof o=="string"&&o.startsWith("obj("))return o.slice(4,-1)}function nr(o){return`arr(${o})`}function $(o){return`obj(${o})`}var K=class o{constructor(t){l(this,"_seq",0);l(this,"client");l(this,"table",new te);l(this,"latest",new he);l(this,"resolved",new Map);l(this,"arraySortedIndicesCache",new Map);l(this,"parentIdOverrides",new Map);l(this,"parentIdHistoryByNodeId",new Map);l(this,"minIndexCache",new Pe({maxSize:1e3}));l(this,"getIdFromObject");l(this,"transactionSeq");l(this,"readTransactionLevel",0);l(this,"foundIds",new Set);this.client=re(t),this.reset()}reset(){this.latest.clear(),this.resolved.clear(),this._seq=0,this.transactionSeq=void 0,this.table=new te,this.arraySortedIndicesCache.clear(),this.minIndexCache.clear()}fromBuffer(t){f(this.transactionSeq===void 0,"You cannot intialise from a buffer during a transaction"),this.reset(),this.table.fromBuffer(t),this.indexRowsOptimized(),this.fixHierarchy()}toBuffer(){return this.table.toBuffer()}get seq(){return this._seq}getRows(t,e){return this.table.getRows(t,e)}getRowsSorted(){return this.getRows().sort(Hr)}indexRowsOptimized(){let{client:t,id:e,key:r,seq:n,value:i}=this.table.columns;for(let s=this.length-1;s>=0;s--)this.updateRowIndex(s,n.get(s),e.get(s),r.get(s),i.get(s),t.get(s))}clone(t){let e=new o(t);return e.fromBuffer(this.toBuffer()),e.indexRowsOptimized(),e.getIdFromObject=this.getIdFromObject,e}createUniqueKeyFromRow(t){return`${t.client}/${t.seq}/${t.id}/${t.key}`}merge(t){return this.mergeRows(t.getRows())}mergeRows(t){f(this.transactionSeq===void 0,"You cannot add rows during a transaction");let e=new Set(this.getRows().map(i=>this.createUniqueKeyFromRow(i))),r=1/0,n=!1;for(let i of t){i.key==="parentid"&&(n=!0);let s=this.createUniqueKeyFromRow(i);e.has(s)||(e.add(s),this.addRowData(i.id,i.key,i.value,i.client,i.seq),r=Math.min(r,i.seq))}return this.resolved.clear(),this.arraySortedIndicesCache.clear(),n&&this.fixHierarchy(r),r}addRows(t){f(this.transactionSeq===void 0,"You cannot add rows during a transaction");let e=1/0,r=!1;for(let n of t)n.key==="parentid"&&(r=!0),this.addRowData(n.id,n.key,n.value,n.client,n.seq),e=Math.min(e,n.seq);return this.resolved.clear(),this.arraySortedIndicesCache.clear(),r&&this.fixHierarchy(e),e}transaction(t){f(this.transactionSeq===void 0,"You cannot nest transactions"),this.transactionSeq=this._seq;let e=t();return this.transactionSeq=void 0,e}updateKeyValue(t,e,r){let n=this.transactionSeq??this._seq;this.addRowData(t,e,r,this.client,n)}addRowData(t,e,r,n,i){let s=this.table.columns.client.length;if(!this.shouldAddRow(t,e,r,i,n))return;let a=this.table.columns;a.client.add(n),a.seq.add(i),a.id.add(t),a.key.add(e),a.value.add(r),this.updateRowIndex(s,i,t,e,r,n)}shouldAddRow(t,e,r,n,i){let s=this.latest.get(t,e);if(s===void 0)return!0;let a=this.table.columns;if(a.value.get(s)!==r)return!0;let c=a.seq.get(s),h=a.client.get(s);return!(c===n&&h===i)}updateRowIndex(t,e,r,n,i,s){e>=this._seq&&(this._seq=e+1);let a=this.latest.get(r,n),d=this.table.columns;if((a===void 0||zr(e,s,d.seq.get(a),d.client.get(a)))&&this.latest.set(r,n,t),this.resolved.delete(r),this.arraySortedIndicesCache.delete(r),n==="parentid"){let c=this.parentIdHistoryByNodeId.get(r);c||(c=[],this.parentIdHistoryByNodeId.set(r,c)),c.push(t)}this.minIndexCache.add(e,t)}getPrevParentId(t,e,r){let n,i=this.parentIdHistoryByNodeId.get(t);if(!i?.length)return n;let s=this.table.columns;for(let a of i){let d=s.seq.get(a);if(d>e||!r&&d===e)continue;let c=s.client.get(a);(!n||d>n.seq||d===n.seq&&c>n.client)&&(n={seq:d,client:c,value:s.value.get(a)})}return n}isAncestorOf(t,e,r,n=new Set){if(t===e)return!0;if(!t||t==="$deleted"||n.has(t))return!1;n.add(t);let i=this.getPrevParentId(t,r,!0);if(!i)return!1;let s=this.parentIdOverrides.get(t)?.get(i.seq)??i.value;return this.isAncestorOf(s,e,r,n)}fixHierarchy(t=0){this.parentIdHistoryByNodeId=new Map([...this.parentIdHistoryByNodeId.entries()].sort((r,n)=>r[0].localeCompare(n[0])));for(let[r,n]of this.parentIdOverrides)for(let[i,s]of n)i>=t&&n.delete(i);let e=this.table.columns;for(let[r,n]of this.parentIdHistoryByNodeId)for(let i of n){let s=e.seq.get(i);if(s<t)continue;let a=e.value.get(i);if(this.isAncestorOf(a,r,s)){let d=this.parentIdOverrides.get(r);d||(d=new Map,this.parentIdOverrides.set(r,d));let c=this.getPrevParentId(r,s,!1);d.set(s,c?c.value:v)}}}getParentId(t){let e=this.latest.get(t,"parentid");if(!e)return;let r=this.table.columns.seq.get(e);return this.parentIdOverrides.get(t)?.get(r)??this.table.columns.value.get(e)}getChildrenIds(t){let e=this.getCurrentValue(t,"children");if(!e)return;let r=dt(e);if(!r)return;let n=this.getArray(r,!1);if(!Array.isArray(n))return;let i=new Set;for(let a of n){let d=pe(a);d&&this.getParentId(d)===t&&i.add(d)}let s=Array.from(this.parentIdOverrides.keys()).sort((a,d)=>a.localeCompare(d));for(let a of s)i.has(a)||this.getParentId(a)===t&&i.add(a);return Array.from(i)}_getIdFromObject(t){return this.getIdFromObject?.(t)}createReferenceId(t,e,r,n,i){if(e===0)return`${r}.${n}`;if(e===1)return`${r}.${i??at(t)}`;ye(e)}getOrCreateReferenceFromValue(t,e,r,n){if(Array.isArray(t)){let i=this.createReferenceId(t,e,r,n,void 0);return this.setArray(i,t),nr(i)}if(me(t)){let i=typeof t.id=="string"?t.id:void 0,s=this._getIdFromObject(t)??this.createReferenceId(t,e,r,n,i);return this.setObject(s,t),$(s)}return t}getReferenceValue(t,e,r,n){let i=dt(t);if(i)return this.getArray(i,!0,r,n);let s=pe(t);return s?this.getObjectInner(s,!0,e,r,n):t}getCurrentValue(t,e){let r=this.latest.get(t,e);if(r!==void 0)return this.table.columns.value.get(r)}getCurrentSeq(t,e){let r=this.latest.get(t,e);if(r!==void 0)return this.table.columns.seq.get(r)}validateObjectUpdate(t,e){if(!me(e))throw new Error("Store.setObject: object is not an object");let r=this._getIdFromObject(e);if(r&&r!==t)throw new Error(`Store.getIdFromObject mismatch: ${r} !== ${t}: The id that we got to update the object is not equal to the result of getIdFromObject. See Store.update.test.ts`);return t}deleteRemovedKeys(t,e){let r=this.latest.getSubMap(t);if(r)for(let[n]of r)n!==q&&(n in e||this.setObjectKey(t,n,v))}tryReuseExistingReference(t,e){let r=dt(t);if(Array.isArray(e)&&r)return this.setArray(r,e),!0;let n=pe(t);return me(e)&&n?(this.setObject(n,e),!0):!1}setObject(t,e){let r=this.validateObjectUpdate(t,e);if(this.deleteRemovedKeys(r,e),Object.keys(e).length===0){this.setObjectKey(r,q,qe);return}for(let n in e)this.setObjectKey(r,n,e[n])}setObjectKey(t,e,r){let n=this.getCurrentValue(t,e);if(this.tryReuseExistingReference(n,r))return n;let i=this.getOrCreateReferenceFromValue(r,0,t,e);return n===i||this.updateKeyValue(t,e,i),n}deleteObjectKey(t,e){this.getCurrentValue(t,e)!==void 0&&this.updateKeyValue(t,e,v)}setObjectKeyPath(t,e,r){if(!e[0])return;let n=t;for(let s=0;s<e.length-1;++s){let a=e[s],d=this.getRawObjectData(n);if(!d)throw new Error("Object not found");let c=d[a];c||(this.setObjectKey(n,a,{}),c=this.getCurrentValue(n,a));let h=pe(c);if(!h){let u=e.slice(0,s+1);throw new Error(`${u} is not an object`)}n=h}let i=e[e.length-1];this.setObjectKey(n,i,r)}getObjectKey(t,e){if(this.getCurrentValue(t,q)!==v)return this.getReferenceValue(this.getCurrentValue(t,e),!0,1/0,0)}getRawObjectData(t){return this.getObjectInner(t,!1,!0)}getObject(t){return this.getObjectInner(t,!0,!0)}getObjectWithShallowChildren(t,e){return this.getObjectInner(t,!0,!0,e,0)}getObjectInner(t,e,r,n=1/0,i=0){this.readTransactionLevel++;let s=()=>{this.readTransactionLevel--,this.foundIds.delete(t)};if(this.foundIds.has(t)){s();return}if(this.foundIds.add(t),!r&&this.resolved.has(t))return s(),this.resolved.get(t);let a=this.latest.getSubMap(t);if(!a){s();return}let d={};r||this.resolved.set(t,d);let c=this.table.columns;if(this.getCurrentValue(t,q)===v){s();return}let h=a.get("children");h!==void 0&&i<n&&(d.children=e?this.getChildrenIds(t)?.map(u=>this.getReferenceValue($(u),r,n,i+1)):c.value.get(h)),a.has("parentid")&&(d.parentid=this.getParentId(t));for(let[u,p]of a){if(u===q||p===void 0)continue;let m=c.value.get(p);m!==v&&(u==="children"||u==="parentid"||(d[u]=e?this.getReferenceValue(m,r,n,i+1):m))}return s(),this.readTransactionLevel===0&&this.foundIds.clear(),d}applyArrayEdits(t,e){let r=0;for(let n of e)switch(n.operation){case"delete":this.arrayRemove(t,n.index+r,1),r--;break;case"insert":this.arrayInsert(t,n.index,n.value),r++;break}}setArray(t,e){let r=this.getArray(t,!1);r||(this.updateKeyValue(t,.5,qe),r=[]);let n=e.map(s=>this.getOrCreateReferenceFromValue(s,1,t,void 0)),i=it(r,n);this.applyArrayEdits(t,i)}getArraySortedIndicesCached(t){let e=this.arraySortedIndicesCache.get(t);if(e)return e;let r=this.latest.getSubMap(t);if(!r)return[];let n=this.table.columns,s=Array.from(r.values()).sort((a,d)=>n.key.get(a)-n.key.get(d)).filter(a=>{let d=n.value.get(a);return d!==v&&d!==qe});return this.arraySortedIndicesCache.set(t,s),s}getArray(t,e=!0,r=1/0,n=0){if(!this.latest.getSubMap(t))return;let s=this.getArraySortedIndicesCached(t),a=this.table.columns,d=[];for(let c of s){let h=a.value.get(c);h===qe||h===v||d.push(e?this.getReferenceValue(h,!0,r,n+1):h)}return d}arrayReplace(t,e,r){return this.arraySplice(t,e,1,r)}arraySplice(t,e,r,...n){if(!this.latest.getSubMap(t))return;let s=this.getArraySortedIndicesCached(t),a=s.length,d=e<0?Math.max(a+e,0):Math.min(e,a),c=r===void 0?a-d:Math.min(r,a-d),h=this.table.columns,u=[];for(let F of s.slice(d,d+c))u.push(h.value.get(F)),this.updateKeyValue(t,h.key.get(F),v);let p=d>0?s[d-1]:void 0,m=p!==void 0?h.key.get(p):0,g=s[d],y=g!==void 0?h.key.get(g):m+1,j=m,k=p!==void 0?h.client.get(p):null,x=p!==void 0?h.seq.get(p):null;for(let F of n){let _=k===this.client&&x!==null?x+1:1,R=st(j,y,this.client,k,x,_);this.updateKeyValue(t,R,this.getOrCreateReferenceFromValue(F,1,t,void 0)),j=R,k=this.client,x=_}return u}arrayInsert(t,e,...r){return this.arraySplice(t,e,0,...r)}arrayRemove(t,e,r=1){return this.arraySplice(t,e,r)}get length(){return this.table.columns.client.length}compact(t){let e=new o(t??`${this.client}`);e.getIdFromObject=this.getIdFromObject;let r=new Set,n=this.table.columns;for(let i=0;i<this.length;i++)r.add(n.id.get(i));for(let i of r){let s=this.latest.getSubMap(i);if(s)for(let[a,d]of s){if(d===void 0)continue;let c=n.value.get(d),h=n.client.get(d),u=n.seq.get(d);c!==v&&e.addRowData(i,a,c,h,u)}}return e}};function ir(o){return typeof o=="object"&&!Array.isArray(o)&&o!==null}function sr(o,t){if(!ir(o)||!ir(t))return t;for(let e of Object.keys(t))o[e]=sr(o[e],t[e]);return o}function or(o,...t){let e=o;for(let r of t)e=sr(e,r);return e}function ar(o){return o===void 0}function Wr(o,t,e){let r=e.replicaInfo;if(r?.master){let s=o.get(r.master);if(!s||!Z(s))return!0}if(r?.inheritsFrom){let s=o.get(r.inheritsFrom);if(!s||!(ae(s)||Z(s)))return!0}let n=e.parentid;if(!n)return!1;let i=o.get(n);return i?o.isAncestorOfNode(i,t):!0}function $r(o,t,{children:e,...r}){if(f(!o.has(t),"Tree must not have node",t),!r.parentid)return null;let n=o.get(r.parentid);if(!n||vt(n)&&!n.isLoaded())return null;let i=r.__class;if(!i)throw new Error("Unknown node class for: "+t);let s=de(i);if(!s)throw new Error("Unknown node class for: "+t);let a=r.replicaInfo;if(a){let c=o.get(a.master);if(!c||!Z(c))throw Error("broken diff, replica without master: "+t+" "+a.master);let h=kt(a),u=Te.create(o,c,{overrides:h?.overrides,owner:t,inheritsFrom:h?.inheritsFrom,duplicatedFrom:r.duplicatedFrom,fromDiff:!0});return u.parentid=r.parentid,o.insertNode(u,u.parentid),u}if(Et(s)){f(Tt(t),"Invalid EntityReferenceNode ID: "+t);let c=new s({...Ke(r),id:t});return o.insertNode(c,c.parentid),c}let d=new s({...Ke(r),id:t});return o.insertNode(d,d.parentid),d}function Kr(o,t){o.has(t)&&o.remove(t)}function Yr(o,t,{children:e,...r}){let n=o.get(t);if(!n)return null;if(r.parentid&&n.parentid!==r.parentid){if(!o.has(r.parentid))return o.remove(t),null;o.move(t,r.parentid)}let i=n.asDraft(o);for(let s in r){let a=i[s];s==="replicaInfo"||typeof a!="object"||Array.isArray(a)||a===null||(r[s]=or({},a,r[s]))}if(r.replicaInfo&&ae(n)){let{overrides:s,_deleted:a,...d}=r.replicaInfo;for(let h in s){let u=s[h];u&&Ut(o,i,h,u)}let c=Object.assign(i.replicaInfo,d);return X.updateNode(o,i,r),i.replicaInfo=c,i.cache.rebuildReplica=!0,i}else return X.updateNode(o,n,r),i}function Gr(o,t){if(o.length!==t.length)return!1;for(let e=0;e<o.length;e++)if(o[e].id!==t[e])return!1;return!0}function Jr(o,t,e){if(Gr(t.children,e))return;let r=[];for(let s=0,a=e.length;s<a;s++){let d=o.get(e[s]);d&&d.parentid===t.id&&r.push(d)}let n=new Set(e),i=t.children;for(let s=0,a=i.length;s<a;s++){let d=i[s];n.has(d.id)||r.push(d)}yt(i,r)||(t.asDraft(o).children=r)}function dr(o,t){o.applyingDiffs=!0;let e=Array.from(t.keys()),r=[...e];for(;r.length>0;){let n=[];for(let i of r){let s=t.get(i);ar(s)||(Wr(o,i,s)?n.push(i):o.has(i)?Yr(o,i,s):s.__class&&$r(o,i,s))}if(n.length===0||n.length===r.length)break;r=n}for(let n of e){let s=t.get(n)?.children;if(!s||s.length===0)continue;let a=o.get(n);if(a){if(!a.children)throw Error("assertion failure: node has no children");Jr(o,a,s)}}for(let n of e){let i=t.get(n);ar(i)&&Kr(o,n)}return o.applyingDiffs=!1,o.commitDiffs()}function ct(o,t){let e=o.getParentId(t);for(;e&&e!==v;)e=o.getParentId(e);return e===v}function Zr(o,t,e){let r=new Map;for(let[n,i]of t){if(ct(o,n)){r.set(n,void 0);continue}let s=o.getObject(n);if(!s.__class||!de(s.__class))continue;let a={id:n,parentid:o.getParentId(n),children:o.getChildrenIds(n)??[]},d=e.has(n)?Object.keys(s).map(c=>[c]):i;for(let c of d){let h=a,u=s;for(let[p,m]of c.entries()){if(m==="parentid"||m==="children"||m===q)break;if(Array.isArray(h)){!h.length&&Array.isArray(u)&&h.push(...u);break}if(!(m in h))if(u?.[m]===void 0)h?._deleted||(h._deleted=[]),h._deleted.push(m);else if(p===c.length-1)h[m]=u[m];else{let y=Array.isArray(u[m]);h[m]=y?[]:{}}h=h[m],u=u[m]}}r.set(n,a),a.parentid&&(r.has(a.parentid)||r.set(a.parentid,{children:o.getChildrenIds(a.parentid)}))}return r}function cr(o,t=0){let e=new Map,r=o.table.columns,n=o.minIndexCache.get(t);for(let i=n;i<r.client.length;++i){if(r.seq.get(i)<t)continue;let a=r.id.get(i),d=r.key.get(i),c=a.split("."),[h,...u]=c,p=e.get(h);p||(p=[],e.set(h,p)),u.push(d),p.push(u)}return e}function Xr(o,t){let e=cr(t),r=new Set;for(let[n,i]of e){let s=t.getCurrentSeq(n,"parentid");if(s===void 0||t.getCurrentValue(n,"parentid")===v)continue;let d=o.getCurrentSeq(n,"parentid");d!==void 0&&(d>s||ct(o,n)&&r.add(n))}return r}function Qr(o,t){let e=[...t];for(let r of e)for(let n of o.getChildrenIds(r)??[])e.push(n);return new Set(e)}function lr(o,t){let e=t.getRows();if(!e.length)return new Map;let r=Xr(o,t),n=o.addRows(e);for(let s of Array.from(r))ct(o,s)&&r.delete(s);r=Qr(o,r);let i=cr(o,n);for(let s of r)i.has(s)||i.set(s,[]);return Zr(o,i,r)}function hr(o){let t=new K(o);return t.getIdFromObject=e=>e.__class&&de(e.__class)?e.id:void 0,t}var lt=class{constructor(t,e){this.id=t;this.store=e;l(this,"loadedScope")}loadScopeDataFromStore(){let t=this.store.getObject(this.id);if(!t){E.debug("No object with id "+this.id+" in the store");return}return t}createNodeFromData(t){let e=this.buildPage(t);if(e)return e.cache.isShallowLoad=!1,e}async run(t){if(this.loadedScope)return this.loadedScope;let e=performance.now(),r=this.loadScopeDataFromStore(),n=performance.now()-e;if(await t.yield(),this.loadedScope)return this.loadedScope;let i=performance.now(),s=this.createNodeFromData(r),a=performance.now()-i;return this.loadedScope=new W(s,n+a),this.loadedScope}force(){if(this.loadedScope)return this.loadedScope;let t=performance.now(),e=this.loadScopeDataFromStore(),r=this.createNodeFromData(e),n=performance.now()-t;return this.loadedScope=new W(r,n),this.loadedScope}buildPage(t){if(!t)return;let e=[],r=E.isLoggingTraceMessages()?[]:void 0,n=O(t,void 0,{extraChecksAndFixes:!0,errors:e,warnings:r});if(n&&Ee(n,e),e.length>0&&E.warn("errors loading server tree: "+e.join(`
`)),r&&r.length>0&&E.trace("warnings loading server tree: "+r.join(`
`)),!!n)return n}},E=b("CrdtDocumentLoader"),ge=class extends H{constructor(e,...r){super(...r);this.store=e;l(this,"parsedIds",new Set)}async loadFirstCrdtTree(e){let r=[],i=this.store.getObjectWithShallowChildren(e.rootId,2),s=i?.homePageNodeId,a=this.settings.activeNodeId,d=a?this.store.getObjectWithShallowChildren(a,2):void 0;if(d){for(;d.parentid!==e.rootId;){if(!d.parentid)throw Error("active node has no parent");d=this.store.getObjectWithShallowChildren(d.parentid,2)}s=d.id}let c=O(i,null,{extraChecksAndFixes:!0,errors:r,warnings:r});if(!c)throw Error("Unable to create load document");let h=[..._t,s];for(let m of h){if(!m)continue;let g=this.store.getObject(m);if(!g){E.debug("No value for "+m);continue}let y=O(g);y.cache.isShallowLoad=!1;let j=c.children.findIndex(k=>k.id===m);c.children[j]=y,this.parsedIds.add(m)}for(let m of c.children)this.parsedIds.has(m.id)||this.scopesToLoad.add(m.id);Vt(c,r),c.children.forEach(m=>{if(!this.parsedIds.has(m.id)&&Array.isArray(m.children)&&gt(m)){m.cache.isShallowLoad=!0;return}});let u=Dt.createByAdoptingRoot(c);u.verify(),u=Te.treeDidLoad(u,[]).didNonLinearMove(ft);let p=[];return Mt(u,p)&&(p.forEach(m=>{r.push(`${m.id}: code component links itself via ${m.stack}`),qt(u,m.id,m.stack)}),u=u.commit()),await this.emitWrapped(()=>{if(this.scheduler.isDone())return;let m=performance.now();u.setService("loader",this),this.emit("loadedFirstData",u),I("parsingFirstPage"),this.parsingDuration+=performance.now()-m}),u}async createTreeFromBuffer(e){this.documentSize=e.byteLength,this.store.fromBuffer(e);let r=this.store.getObject("meta");if(!r)throw new Error("Meta field not found");if(!mt(r.version))throw Error("cannot read document version");for(this.canvasTreeVersion=r.version,E.debug("createTree",this.canvasTreeVersion,z(this.documentSize),C(this.loadingDuration)),this.emit("loadedDocumentVersion",r.version),this.tree=await this.loadFirstCrdtTree(r),this.loadedFirstScope=!0,this.updatePauseResumeState(),await this.scheduler.yield(),I("parsingResume");this.hasNextScopeToLoad();)await this.loadNextCrdtScopeAsync(),await this.scheduler.yield();await this.emitWrapped(()=>{f(this.tree,"tree must have been set"),this.tree.setService("loader",void 0),this.emit("loadedAllData")}),E.debug("done",z(this.documentSize),"loading:",C(this.loadingDuration),"parsing:",C(this.parsingDuration))}async start(){await this.scheduler.run(async()=>{E.debug("start"),I("parsingInit"),this.updatePauseResumeState();let e=performance.now(),r=await this.loadCrdtData();this.loadingDuration=performance.now()-e,await this.scheduler.yield(),await this.createTreeFromBuffer(r)})}async loadCrdtData(){let e=this.settings.initData,r=e?.version===this.treeVersion,n=e?.prefetchPromise;if(E.debug("loadData: prefetch"),r&&n){e&&delete e.prefetchPromise;let s=await n;if(n.then(a=>a.duration).then(a=>{I("dataLoad",a)}),await this.scheduler.yield(),s.status<200||s.status>=300)throw new Error(`Failed to fetch project data. Status code: ${s.status}`);if(s.buffer){E.debug("loadData: prefetch bytes parser");let a=await s.buffer;return await this.scheduler.yield(),new Uint8Array(a)}}E.debug("loadData: fetch");let i;this.settings.refreshAccessToken&&(i=await this.settings.refreshAccessToken({}),await this.scheduler.yield());for(let s=0;s<Ue;++s){let a=await fetch(this.documentURL,i);if(a.ok){await this.scheduler.yield();let d=await a.arrayBuffer();return await this.scheduler.yield(),new Uint8Array(d)}(a.status<200||a.status>=300)&&(E.debug("onErrorStatusLoaded, retry:",s),await this.scheduler.sleep(s*le+Math.random()*le))}throw Error(`Failed to fetch project data after attempting ${Ue} times`)}async loadNextCrdtScopeAsync(){f(!this.currentLoadingScope,"already have a currently loading scope");let e=this.nextScopeIdToLoad();this.currentLoadingScope=new lt(e,this.store);let r=await this.currentLoadingScope.run(this.scheduler);E.debug("loadScopeAsync:",e,C(r.duration),"scheduler mode:",this.scheduler.currentMode()),r.hasNode()&&await this.emitWrapped(()=>{if(this.scheduler.isDone())return;let n=performance.now(),i=r.take();this.currentLoadingScope=void 0,i&&(this.emit("loadedScope",i),this.parsingDuration+=r.duration+performance.now()-n,this.signalScopeLoadCallbacks(i.id))})}};function ur(o){if(!o.children)return;let t=new Map;for(let e of o.children)Z(e)&&t.set(e.id,{master:e,replicas:new Map});for(let e of o.children){if(!ae(e))continue;let r=t.get(e.replicaInfo.master);r&&r.replicas.set(e.id,e)}for(let{master:e,replicas:r}of t.values())en(e,r)}function en(o,t){for(let e of t.values()){let r=e.replicaInfo;f(r.master===o.id,"Replica must match master");let n=r.overrides;if(r.inheritsFrom){let u=t.get(r.inheritsFrom);u&&(n=St(n,u.replicaInfo.overrides))}let i=n[o.id],s=e.duplicatedFrom;X.copyToNode(e,o,i),e.duplicatedFrom=s;let a=!1;bt(e)&&(a=!0,wt(e,n,o),$e(o,e));let d=e.id,c=o.children;if(!c)return;let h=new Array(c.length);for(let u=0,p=c.length;u<p;u++)h[u]=fr(d,n,c[u],d,a);e.children=h}}function fr(o,t,e,r,n){let i=O({__class:e.__class,id:o+e.id,parentid:r});f(i,"Failed to create replica node");let s=t[e.id];if(X.copyToNode(i,e,s),i.duplicatedFrom=null,n&&$e(e,i),e.children){let a=e.children,d=new Array(a.length);for(let c=0,h=a.length;c<h;c++)d[c]=fr(o,t,a[c],i.id,n);i.children=d}return i}var D=b("remote:sync"),mr=2**52,ne=class{constructor(t,e=0,r){this.timeline=t;l(this,"rollingDiff",null);l(this,"session",Math.floor(Math.random()*mr));l(this,"seq",0);l(this,"treeVersion",0);l(this,"updatesSeen",0);l(this,"init",0);l(this,"expectingInitialUpdates",0);l(this,"localUpdatesInFlight",[]);l(this,"localUpdatesAtInit",[]);l(this,"hasError",!1);l(this,"waitingForTree",!1);this.setTree(t.tree,e,r)}get waitingForInitialUpdates(){return this.expectingInitialUpdates>this.updatesSeen}get isLoading(){return this.waitingForTree||this.waitingForInitialUpdates}get isReady(){return!(this.hasError||this.waitingForTree||this.waitingForInitialUpdates)}get tree(){return this.timeline.tree}error(t){return this.hasError=!0,Error(t)}verify(t,e){let r=this.timeline.getTreeForVersion(t);if(!r)return D.info("verify: unable to find tree with version",t),!0;let n=r.computeTreeHash();if(n!==e){if(D.warn("verify: failed",n,"!==",e),e===0)return!0;D.reportError("Tree verification failed",{localHash:n,serverHash:e,treeVersion:t,treeSize:r.size()})}else D.debug("verify: passed; hash:",e);return n===e}setTree(t,e,r){D.info("setTree",e),this.timeline.reset(t,r),this.setRemoteTreeVersion(e),!!r?.isLoading&&B.isOn("rollingDiff")&&(this.rollingDiff=new Le,this.rollingDiff.addChanges(r?.initialChanges)),this.treeVersion=e,this.waitingForTree=!1,this.hasError=!1,this.localUpdatesInFlight=[]}resetSession(){this.treeVersion=0,this.session=Math.floor(Math.random()*mr),this.localUpdatesInFlight=[],this.localUpdatesAtInit=[]}debugResetSessionAndTree(t){this.resetSession(),this.setTree(t,0)}handleInit(t,e){return this.init+=1,this.init===1&&I("wsTreeInitMessages"),D.info("init",this.init,{treeVersion:t,initialUpdates:e,localTreeVersion:this.treeVersion}),D.debug("init updates:",{seen:this.updatesSeen,inFlight:this.localUpdatesInFlight.length,previous:this.localUpdatesAtInit.length}),this.hasError=!1,this.expectingInitialUpdates=e,this.updatesSeen=0,this.localUpdatesAtInit=this.localUpdatesInFlight.slice(),this.treeVersion!==t||this.waitingForTree?(this.waitingForTree=!0,!0):!1}trimForShallowLoading(){let t=this.timeline,e=this.getRemoteIndex()-3;e<=0||(t.trimmed+=e,D.debug("trim",e,"new offset:",t.trimmed,"entries.length:",t.entries.length,"after load"),t.entries.splice(0,e),f(this.timeline.remoteTreeIndex===0||this.getRemoteIndex()>=0,"must have some buffer before remoteTreeIndex"))}loadedAllScopes(){let t=this.timeline;D.info("done loading, took:",Math.round((performance.now()-t.resetTime)/100)/10,"seconds"),f(t.isPartialLoading,"Must be in loading mode"),t.isPartialLoading=!1,this.rollingDiff=null;let e=this.getRemoteEntry();e&&(e.version=t.remoteTreeVersion,this.trimForShallowLoading())}loadOneScope(t,e){let r=this.timeline;D.debug("loadOneScope:",t.id),f(r.isPartialLoading,"Must be loading"),f(!t.cache.isShallowLoad,"Scope must not be shallow");let n=this.getRemoteEntry();f(n,"remote tree is missing");let i=r.tree.isViewOnly;n.tree.editClosed=!1,n.tree.isViewOnly=!1,n.tree.inEditor=!1,n.tree.makeLatest();let s=new Set,a=n.tree.root.children.findIndex(c=>c.id===t.id);if(t.__class==="WebPageNode"||t.__class==="SmartComponentNode"){ur(t),n.tree=n.tree.commitWithLoadedScope(t);for(let c of t.walk())r.trackChange(c.id),s.add(c.id)}else n.tree.remove(t.id),n.tree.insertNode(t,n.tree.root.id,a);if(this.rollingDiff){let c=this.rollingDiff.getChanges();s.size>0?Je(c,s)&&N(n.tree,c):N(n.tree,c)}else{let c=0,h=s.size>0,u=this.getRemoteIndex();for(let p of r.entries){if(c>u)break;c++,!p.wasScopeInsert&&(h&&!Je(p.changes,s)||(h=!1,N(n.tree,p.changes)))}}a===-1?f(!n.tree.get(t.id),"Scope must have been deleted by remote diffs"):n.tree.loadReplicasAndCodeComponents(t);let d=n.tree.commit((c,h)=>{let u=c?.id??h?.id;u&&r.trackChange(u)});return n.tree.inEditor=!0,d.inEditor=!0,this.incrementRemoteTreeIndex(),e||(r.latestReversibleNodeChanges=null),this.addTreeToTimeline(d),r.legacyMode&&r.invalidateAllCursors(),d.isViewOnly=i,this.rollingDiff&&this.trimForShallowLoading(),r.tree}getRemoteEntry(){return this.timeline.getEntry(this.getRemoteIndex())}setRemoteTreeVersion(t){if(this.timeline.remoteTreeVersion=t,this.timeline.isPartialLoading)return;let e=this.getRemoteEntry();f(e,"remote tree is missing"),e.version=t}};var pr=b("remote:sync"),je=class extends ne{constructor(e,r=0,n){super(e,r,n);l(this,"lastValidLocalIndex",0);l(this,"lastRemoteIndex",0);this.timeline.enableAddRemoveOptimizations=!1}setTree(e,r,n){super.setTree(e,r,n),this.lastValidLocalIndex=0,this.lastRemoteIndex=0}handleRemoteUpdate(e,r){if(this.hasError||this.waitingForTree)return;pr.trace("this:",this.session,this.seq,"at:",this.treeVersion,"update:",e),this.treeVersion=r.rows.reduce((c,h)=>Math.max(c,h.seq),this.treeVersion);let n=this.timeline,i=this.timeline.getLastEntry();f(i,"remote tree is missing");let s=n.tree.isViewOnly;i.tree.editClosed=!1,i.tree.isViewOnly=!1,i.tree.makeLatest(),i.tree.beginAllowPartialScopeAccess();let a=dr(i.tree,e),{changes:d}=Lt(i.tree,a);for(let c of d)n.trackChange(c.id,c);for(let c of i.tree.getNodesChangedByCommit())n.trackChange(c.id);return n.latestReversibleNodeChanges=null,this.timeline.addEntry(a,d,[],!1,!0),this.lastRemoteIndex=this.timeline.length-1,this.trim(),this.setRemoteTreeVersion(this.treeVersion),i.tree.endAllowPartialScopeAccess(),a.isViewOnly=s,d}addTreeToTimeline(e){let r=this.timeline.addEntry(e,[]);r.wasScopeInsert=!0}getRemoteIndex(){return this.timeline.entries.length-1}incrementRemoteTreeIndex(){}hasChangesForRemote(){let e=this.lastValidLocalIndex,r=this.timeline.length-1;return f(e<=r,"inconsistency in getting local changes to send"),e<r}hasOnlyEmptyChangesForRemote(){let e=this.lastValidLocalIndex,r=this.timeline.length-1;return e>=r?!0:this.timeline.computeForwardChanges(e,r).length===0}getForwardChangesForRemote(){let e=this.lastValidLocalIndex,r=this.timeline.length-1,n=this.timeline.getChangesBetweenEntries(e,r);return this.lastValidLocalIndex=r,n}resetTreesForRecovery(){return this.timeline.resetTreesForRecovery(this.lastRemoteIndex-this.timeline.trimmed,this.lastValidLocalIndex-this.lastRemoteIndex)}trimForShallowLoading(){}trim(){if(this.timeline.isPartialLoading)return;let e=this.lastValidLocalIndex-this.timeline.trimmed-100;e<=75||(this.timeline.trimmed+=e,pr.debug("trim",e,"new offset:",this.timeline.trimmed,"entries.length:",this.timeline.entries.length),this.timeline.entries.splice(0,e))}};function ie(o){let{appEnvironment:t,session:e,seq:r,count:n,reasons:i,changes:s}=o;return{appEnvironment:t,session:e,seq:r,changes:s,count:n,reasons:i}}function gr(o,t){return{...o,next:t}}var tn={cache:!0,update:!0,mutable:!0,children:!0};function rn(o,t){if(o!=="cached")return t}function yr(o){return JSON.parse(JSON.stringify(o,rn))}function _e(o,t,e){let r=new Set,n=!1;function i(a,d){r.add(a.id),d+="."+a.id;let c=t.get(a.id);if(!c)n=!0,e.push("-node: "+d+(ve(a)?" (replica child)":""));else{let h=[],u=a.children?.map(m=>m.id).join(","),p=c.children?.map(m=>m.id).join(",");u!==p&&h.push(" .children: ["+u+"] != ["+p+"]");for(let[m,g]of a.entries()){if(m in tn)continue;let y=c[m];oe(g,y)?g&&typeof g=="object"&&g.__proto__!==(typeof y=="object"&&y&&"__proto__"in y?y.__proto__:void 0)&&h.push(" ."+m+": different prototypes"):(g===void 0||y===void 0||!oe(yr(g),yr(y)))&&m!=="contentHash"&&h.push(" ."+m+": "+JSON.stringify(g)+" != "+JSON.stringify(y))}h.length>0&&(n=!0,e.push("!node: "+d+(ve(a)?" (replica child)":"")),e.push(...h))}for(let h of a.children??[])i(h,d)}function s(a,d){d+="."+a.id,r.has(a.id)||(n=!0,e.push("+node: "+d+(ve(a)?" (replica child)":"")));for(let c of a.children??[])s(c,d)}return i(o.root,""),s(t.root,""),n}var w=b("remote:connection"),Y=b("remote:verify"),nn=5,br=class{constructor(t,e,r,n){this.userId=e;this.projectId=r;this.callbacks=n;l(this,"treeSync");l(this,"remoteUpdates",[]);l(this,"ignoreTreeVerifies",!1);l(this,"ignoreTreeVerifyVersion",0);l(this,"shouldCrashFromDebug",!1);l(this,"loader");l(this,"documentSize",0);l(this,"loaderPromise");l(this,"needsDownload",!1);l(this,"needsProcessUpdatesAfterInit",!1);l(this,"store");l(this,"minSeqToSend",0);l(this,"unconfirmedCrdtRows",new Map);l(this,"crdtRowSeq",0);this.treeSync=new je(t),this.store=hr(this.userId),this.treeSync.waitingForTree=!0,window.store=this.store}get treeVersion(){return this.treeSync.treeVersion}get isReady(){return this.treeSync.isReady}get waitingForTree(){return this.treeSync.waitingForTree}get waitingForInitialUpdates(){return this.treeSync.waitingForInitialUpdates}get timeline(){return this.treeSync.timeline}get isLoading(){return this.treeSync.isLoading}get localUpdatesInFlight(){return this.treeSync.localUpdatesInFlight}get localUpdatesAtInit(){return this.treeSync.localUpdatesAtInit}get hasError(){return this.treeSync.hasError}get init(){return this.treeSync.init}get session(){return this.treeSync.session}setTree(t,e,r){this.treeSync.setTree(t,e,r)}get hasUpdatesToProcess(){return!this.waitingForTree&&!this.needsDownload&&(this.needsProcessUpdatesAfterInit||this.remoteUpdates.length>0)}resetSession(){this.treeSync.resetSession(),this.unconfirmedCrdtRows.clear(),this.crdtRowSeq=0}debugResetSessionAndTree(t){this.treeSync.debugResetSessionAndTree(t)}debugCrash(){this.shouldCrashFromDebug=!0}canProcessChanges(){if(this.treeSync.trim(),!this.treeSync.isReady||this.shouldCrashFromDebug){if(this.treeSync.hasOnlyEmptyChangesForRemote())return!1;let t="is not ready";throw this.treeSync.hasError?t="had an error":this.treeSync.waitingForTree?t="is waiting for tree data":this.treeSync.waitingForInitialUpdates?t="is waiting for initial updates":this.shouldCrashFromDebug&&(this.shouldCrashFromDebug=!1,t="is doing a deliberate crash test"),this.treeSync.error("cannot create local updates when the document "+t)}return!0}processViewOnly(){if(!this.treeSync.hasChangesForRemote())return;let{changes:t}=this.treeSync.getForwardChangesForRemote();w.warn("cannot create local updates when the user is a viewer, ignoring:",t)}prepareLocalChanges(){if(!this.treeSync.hasChangesForRemote())return;let{changes:t}=this.treeSync.getForwardChangesForRemote();t.length>0&&(this.updateStoreFromChanges(t),w.debug("Added local changes to CRDT store:",t.length,"changes, new store length:",this.store.length))}resumeLoadingScopes(){this.loader?.resumeLoadingScopes()}handleRows(t,e){this.remoteUpdates.push(e)}handleConfirmRows(t){for(let[e,r]of this.unconfirmedCrdtRows.entries())r.seq<=t&&(this.unconfirmedCrdtRows.delete(e),w.debug("confirmed CRDT row:",e,"seq:",r.seq));w.debug("confirmed CRDT rows up to seq:",t,"remaining unconfirmed:",this.unconfirmedCrdtRows.size)}handleInit(t,e){this.remoteUpdates.length=0;let r=this.treeSync.handleInit(t,e);this.needsDownload=r,this.needsProcessUpdatesAfterInit=!0}handleMigration(t){this.treeSync.treeVersion=t}handleReload(t){this.remoteUpdates.length=0,this.treeSync.hasError=!0;let e=new Error(t||"Server reloaded document.");this.callbacks.error(e)}handleTreeUpdate(){throw new Error("Json tree updates cannot be handled by Crdt data handler")}handleTreeVerify(t,e,r){if(!this.treeSync.isReady||this.ignoreTreeVerifies||this.ignoreTreeVerifyVersion===e)return;if(!this.treeSync.verify(e,r)){let s=this.treeSync.timeline.getTreeForVersion(e);if(s){let d=this.treeSync.timeline.entries.slice();this.verifyLocalTreeWithServer(t,s,e,d)}this.remoteUpdates.length=0,this.treeSync.hasError=!0;let a=new Error("Local document out of sync with document on server.");this.callbacks.error(a);return}let n=Re(),i=!!window.location.hostname.match(/development/u);if(n||i){let s=this.treeSync.timeline.getTreeForVersion(e);if(s){let a=this.treeSync.timeline.entries.slice();this.verifyLocalTreeWithServer(t,s,e,a)}}}processRemoteUpdates(){if(w.debug("processRemoteUpdates: starting - waitingForTree:",this.treeSync.waitingForTree,"waitingForInitialUpdates:",this.treeSync.waitingForInitialUpdates,"hasError:",this.treeSync.hasError,"isReady:",this.isReady,"remoteUpdates.length:",this.remoteUpdates.length),this.needsProcessUpdatesAfterInit=!1,this.treeSync.waitingForTree){w.debug("processRemoteUpdates: exiting early - waitingForTree=true");return}let t;try{if(f(!this.timeline.tree.hasUncommittedChanges(),"tree must not have uncommitted changes"),this.shouldCrashFromDebug)throw this.shouldCrashFromDebug=!1,Error("RemoteDocument CrashTest");for(;this.remoteUpdates.length>0;){let e=this.remoteUpdates.shift();if(!e)break;t=e;let r=this.writeServerUpdateToTheStore(e);if(this.ensureAllScopesAreLoaded(r),r){let n=this.treeSync.handleRemoteUpdate(r,e);n&&this.loader?.addNodeChanges(n)}e.rows.length>0&&this.treeSync.expectingInitialUpdates>0&&(w.debug("handleRows: counting",e.rows.length,"rows as updates toward initial updates"),this.treeSync.updatesSeen+=e.rows.length,w.debug("handleRows: updatesSeen now:",this.treeSync.updatesSeen,"still expecting:",this.treeSync.expectingInitialUpdates-this.treeSync.updatesSeen))}if(this.loader){let e=this.timeline.tree.root.children;if(!e.some(n=>M(n)&&n.isValid())){w.info("cannot show any page, forcing load of next page");let n=e.find(s=>M(s));if(!n)throw Error("No scope to load");let i=this.loader.loadScope(n.id);if(!i)throw Error("Unable to load scope");this.treeSync.loadOneScope(i,!1)}}this.callbacks.updateProcessed(this.timeline.tree)}catch(e){let r=be(e);throw this.remoteUpdates.length=0,w.error("Error processing remote updates:",r),w.debug("Last update:",t),this.callbacks.errorRecoverable(),this.treeSync.error(r.message),r}}async verifyTreeWithServer(){let t=new URL(`/projects/${this.projectId}/tree/latest?forceSnapshot=true`,window.location.href),e;try{this.ignoreTreeVerifies=!0,e=await fetch(t,await Q.withAuthorizationHeader({}))}finally{this.ignoreTreeVerifies=!1}if(!e.ok)throw Error(`unable to fetch document json: ${e.status} ${e.statusText}`);let r=e.headers.get("etag")||"",n=Number.parseInt(r.match(/Version-(\d+)/u)?.[1]??"0",10);if(!Number.isFinite(n)||n<=0)throw Error(`unable to parse document tree version from: ${r}`);let i=this.treeSync.treeVersion-n,s=this.treeSync.timeline.getTreeForVersion(n);if(!s)throw Error(`unable to get the local tree for version ${n}`);this.ignoreTreeVerifyVersion=n;let a=await e.text(),d=await this.loadServerTree(a,t.toString(),n),c=this.compareTreeWithServerJson(s,d,n);if(c)throw c;return i}async loadServerTree(t,e,r){let n,i=new ge(this.store,r,e,{partialParsing:!0,loadInBackground:!0,loadedData:t,requestIdleCallback:this.callbacks.requestIdleCallback});return i.on("loadedFirstData",s=>{i.on("loadedScope",a=>{let d=s.root.children.findIndex(c=>c.id===a.id);s.remove(a.id),s.insertNode(a,s.root.id,d),s=s.commit()}),i.on("loadedAllData",()=>{n=s})}),await i.start(),f(n,"loadedAllData not called"),n}clearRemoteUpdates(){this.remoteUpdates.length=0}sendRemainingInflightUpdates(t){let e=this.localUpdatesInFlight.length>0,r=this.unconfirmedCrdtRows.size>0;if(!e&&!r)return!1;let n=this.getRowsToSend();if(n.length>0&&t.sendMessage({type:"rows",value:{seq:++this.crdtRowSeq,rows:n}}),r){let i=Array.from(this.unconfirmedCrdtRows.values());i.length>0&&(w.debug("resending unconfirmed CRDT rows:",i.length),t.sendMessage({type:"rows",value:{seq:0,rows:i.map(s=>({client:s.client,seq:s.seq,id:s.id,key:s.key,value:s.value}))}}))}return!0}resendPreviousLocalUpdates(t){f(this.isReady);let e=this.localUpdatesAtInit.filter(n=>!n.confirmed);if(e.length>0){w.debug("resending local updates:",e.length);for(let n of e)t.sendMessage({type:"treeUpdate",value:ie(n)})}let r=Array.from(this.unconfirmedCrdtRows.values());r.length>0&&(w.debug("resending unconfirmed CRDT rows during reconnection:",r.length),t.sendMessage({type:"rows",value:{seq:0,rows:r.map(n=>({client:n.client,seq:n.seq,id:n.id,key:n.key,value:n.value}))}}))}cancelAndClearLoader(){this.loader?.scheduler.cancel(),this.loader=void 0}maybeSend(t){if(!this.treeSync.isReady||this.store.seq<this.minSeqToSend)return"nothingToSend";let e=this.treeSync.localUpdatesInFlight.length;if(e>=nn)return"postpone";let r=this.getRowsToSend();return r.length>0?(w.debug("sending CRDT rows:",e,r.length,"rows"),t.sendMessage({type:"rows",value:{seq:++this.crdtRowSeq,rows:r}}),"didSend"):"nothingToSend"}updateStoreFromChanges(t){for(let e of t)this.store.transaction(()=>{let{_deleted:r,...n}=e.to;if(xt(e.id)){let[i,s]=Nt(e.id);if(e.removed){this.store.setObjectKey(e.id,"parentid",v);return}let a=n;if(r)for(let d of r)a[d]=v;if(this.store.setObjectKeyPath(i,["replicaInfo","overrides",s],a),e.toChildren){let d=e.toChildren.map(c=>$(c));this.store.setObjectKey(e.id,"children",d);for(let c of e.toChildren)this.store.setObjectKey(c,"parentid",e.id)}}else{if(e.added){let a={...e.to,id:e.id,__class:e.added};e.toChildren&&(a.children=e.toChildren.map(d=>$(d))),this.store.setObject(e.id,a);return}if(e.removed){this.store.setObjectKey(e.id,"parentid",v);return}for(let a in e.to)this.store.setObjectKey(e.id,a,n[a]);let i=e.added||"__class"in n,s="id"in n;if(i&&!s&&this.store.setObjectKey(e.id,"id",e.id),r)for(let a of r)this.store.setObjectKey(e.id,a,void 0);if(e.toChildren){let a=e.toChildren.map(d=>$(d));this.store.setObjectKey(e.id,"children",a)}}})}writeServerUpdateToTheStore(t){let e=new K("temp"),r=t.rows.map(n=>({...n,client:re(n.client)}));return e.addRows(r),lr(this.store,e)}ensureAllScopesAreLoaded(t){if(!this.loader)return;let e=new Set,r=this.timeline.tree;for(let[n,i]of t){let s=i?.parentid;if(!s)continue;let a=r.get(s);if(a){let c=r.getScopeNodeFor(a);c&&e.add(c.id)}let d=r.get(n)?.parentid;if(d){let c=r.get(d);if(c){let h=r.getScopeNodeFor(c);h&&e.add(h.id)}}}for(let n of e){if(this.loader.hasLoadedScope(n))continue;let i=this.loader.loadScope(n);i&&this.treeSync.loadOneScope(i,!1)}}createLoader(t,e,r){this.needsDownload=!1,this.loader?.scheduler.cancel();let n=new ge(this.store,e,t,r);return this.loader=n,n.on("loadedFirstData",()=>{this.minSeqToSend=this.store.seq,w.debug("Reset last sent seq to current store length:",this.minSeqToSend)}),this.loader}finishLoading(){this.loader=void 0}async verifyLocalTreeWithServer(t,e,r,n){try{let i=t.replace(/\d+\.json/u,r+".json"),s=await fetch(i,await Q.withAuthorizationHeader({}));if(!s.ok)throw Error(`unable to fetch document json: ${s.status} ${s.statusText}`);let a=await s.text(),d=await this.loadServerTree(a,i,r);this.compareTreeWithServerJson(e,d,r,n)}catch(i){Y.error("Error:",i)}}compareTreeWithServerJson(t,e,r,n){Y.debug("local:",t.computeTreeHash(),t.size(),"remote:",e.computeTreeHash(),e.size(),"version:",r);let i,s=[];return _e(t,e,s)?(Y.warn(`trees are different
`+s.join(`
`)),n&&Y.debug("timeline.entries",n),i=Error("Local document different from server document."),Y.reportError(i,{differences:s,changes:n?.slice(-25).map(d=>d.changes)})):s.length>0?Y.debug(`trees have warnings:
`+s.join(`
`)):Y.debug("trees are same"),i}getRowsToSend(){let t=this.store.minIndexCache.get(this.minSeqToSend),e=this.store.getRows(t);w.debug("getRowsToSend: allRows from store:",e.length,"store total length:",this.store.length),w.debug("store.client:",this.store.client,"userId:",this.userId),w.debug("store.client (hashed):",this.store.client,"expected client hash:",re(this.userId));let r=e.filter(i=>{let s=i.client===this.store.client,a=i.seq>=this.minSeqToSend;return s&&a}).map(i=>({id:i.id,key:i.key,client:this.userId,seq:i.seq,value:i.value}));r.forEach(i=>{let s={client:this.userId,seq:i.seq,id:i.id,key:i.key,value:i.value,timestamp:Date.now(),retryCount:0},a=`${this.userId}_${i.seq}`;this.unconfirmedCrdtRows.set(a,s),w.debug("tracking CRDT row:",a,"seq:",i.seq)}),w.debug("getRowsToSend: returning",r.length,"rows");let n=r.reduce((i,s)=>Math.max(i,s.seq),0);return w.debug("Setting minSeqToSend from",this.minSeqToSend,"to",n+1),this.minSeqToSend=n+1,r}loadedAllScopes(){this.treeSync.loadedAllScopes()}loadOneScope(t,e){return this.treeSync.loadOneScope(t,e)}hasUnconfirmedChanges(){return this.unconfirmedCrdtRows.size>0}resetTreesForRecovery(){return this.treeSync.resetTreesForRecovery()}error(t){return this.treeSync.error(t)}};function Sr(o){return typeof o=="object"&&o!==null&&"next"in o}function Be(o){return Sr(o)&&"session"in o}function ze(o){return Sr(o)&&"changes"in o&&Array.isArray(o.changes)}var A=b("remote:sync"),He=class extends ne{constructor(){super(...arguments);l(this,"localChangesSentToRemote",0)}setTree(e,r,n){super.setTree(e,r,n),this.localChangesSentToRemote=0}handleRemoteUpdate(e){if(this.hasError||this.waitingForTree)return;f(typeof e.next=="number","must be a valid tree update");let r=e.next;if(A.trace("this:",this.session,this.seq,"at:",this.treeVersion,"update:",e),r!==this.treeVersion+1){if(r<=this.treeVersion){A.debug("ignoring old update:",r," <= ",this.treeVersion);return}throw this.error("missing update: "+this.treeVersion+" + 1 != "+r)}if(this.updatesSeen+=1,this.treeVersion=r,Be(e)&&e.session===this.session){let n=this.localUpdatesInFlight[0];if(n?.seq===e.seq)this.localUpdatesInFlight.shift(),this.confirmLocalChangesByRemote(n.count,r),n.confirmed=!0;else{let i=this.localUpdatesAtInit.find(s=>s.seq===e.seq);if(i)this.insertRemoteChanges(i.changes,r),i.confirmed=!0;else{let s=this.localUpdatesInFlight.findIndex(d=>d.seq===e.seq),a=s===-1?"unknown local update: "+e.seq+" != "+n?.seq:"missing local update: "+e.seq+" != "+n?.seq+", is index: "+s;throw this.error(a)}}}else ze(e)?e.changes.length>0&&this.insertRemoteChanges(e.changes,r):A.reportErrorOncePerMinute(new Error("Unknown remote update"),{update:e})}confirmLocalChangesByRemote(e,r=0){let n=this.timeline;if(f(e>=1,"cannot confirm less than one change"),f(this.localChangesSentToRemote>=e,"cannot confirm local changes that have not been sent"),f(n.remoteTreeIndex<n.localTreeIndex,"must have unconfirmed local changes"),this.rollingDiff)for(let i=1;i<=e;i++)this.rollingDiff.addChanges(n.getEntry(n.remoteTreeIndex+i)?.changes);return this.localChangesSentToRemote-=e,n.incrementRemoteTreeIndex(e),this.setRemoteTreeVersion(r),n.tree}insertRemoteChanges(e,r=0){let n=this.timeline;A.debug("insertRemoteChanges:",e.length),f(n.tree===n.getLastEntry().tree,"tree out of sync"),f(n.remoteTreeIndex<=n.localTreeIndex,"remote tree too far ahead"),this.rollingDiff&&this.rollingDiff.addChanges(e);let i=this.getRemoteEntry();f(i,"remote tree is missing");let s=n.tree.isViewOnly;i.tree.editClosed=!1,i.tree.isViewOnly=!1,i.tree.makeLatest(),i.tree.beginAllowPartialScopeAccess(),N(i.tree,e);let a=i.tree.commitDiffs();for(let c of e)n.trackChange(c.id,c);for(let c of i.tree.getNodesChangedByCommit())n.trackChange(c.id);n.incrementRemoteTreeIndex(1),n.latestReversibleNodeChanges=null;let d=n.entries.length-this.getRemoteIndex();return f(d>=0,"computed rebase is off"),d===0?this.addRemoteTreeWithChanges(a,e):this.rebaseRemoteTreeWithChanges(a,e,d),this.trim(),this.setRemoteTreeVersion(r),i.tree.endAllowPartialScopeAccess(),a.isViewOnly=s,n.tree}addRemoteTreeWithChanges(e,r){A.trace("addRemoteTreeWithChanges:",r.length);let n=this.timeline.getLastEntry();return f(e.lineage===n.tree.lineage,"Trees must belong to the same line."),f(!e.hasUncommittedChanges(),"Tree cannot have uncommitted changes."),n.tree!==e&&n.tree.releaseMemory(),this.timeline.addEntry(e,r)}rebaseRemoteTreeWithChanges(e,r,n){let i=this.timeline;A.debug("rebaseRemoteTreeWithChanges:",n,"changes:",r.length),f(e.lineage===i.getLastEntry().tree.lineage,"Trees must belong to the same line."),f(!e.hasUncommittedChanges(),"Tree cannot have uncommitted changes."),f(i.entries.length>=n,"rebase",n,"> commits",i.entries.length);let s=i.entries.splice(i.entries.length-n,n);f(s.length===n,"must have",n,"entries to process");let a=i.addEntry(e,r,[],!0),d=e;for(let c=0;c<n;c++){let h=s[c];N(e,h.changes),e=e.commitDiffs();for(let u of h.changes)i.trackChange(u.id,u);for(let u of d.getNodesChangedByCommit())i.trackChange(u.id);i.addEntry(e,h.changes,h.editReasons,h.wasRebase),e!==d&&(d.releaseMemory(),d=e)}return i.tree=e,a}addTreeToTimeline(e){let n=this.timeline.entries.length-this.getRemoteIndex();f(n>=0,"computed rebase is off");let i;n===0?i=this.addRemoteTreeWithChanges(e,[]):i=this.rebaseRemoteTreeWithChanges(e,[],n),i.wasScopeInsert=!0}loadCompleteTree(e,r=0){let n=this.timeline;A.debug("load complete tree:",n.tree.sizeAtStart(),"->",e.size(),"entries:",n.entries.length),f(n.trimmed===0,"cannot load complete tree while having local changes"),f(!e.hasUncommittedChanges(),"tree should be clean"),n.entries.forEach((d,c)=>{c>n.remoteTreeIndex||N(e,d.changes)}),e.hasUncommittedChanges()&&(e=e.commitDiffs());let i=[],s=n.tree;if(s.sizeAtStart()*2>e.size()){let d={};for(let c of e.root.walk()){let h=s.getNodeAtStart(c.id)||void 0,u=Ce(h,c);u&&(d[u.id]=u),n.trackChange(c.id,u)}i=Object.values(d),A.debug("load complete tree, diff:",i.length)}else n.invalidateAllCursors(),A.debug("load complete tree, resending:",n.tree.size());n.incrementRemoteTreeIndex(1),n.latestReversibleNodeChanges=null;let a=n.entries.length-n.remoteTreeIndex;return f(a>=0,"computed rebase is off"),e.lineage!==n.tree.lineage?(n.reset(e),this.setRemoteTreeVersion(r),n.tree):(a===0?this.addRemoteTreeWithChanges(e,i):this.rebaseRemoteTreeWithChanges(e,i,a),this.setRemoteTreeVersion(r),this.trim(),n.tree.forEachNode(d=>n.trackChange(d.id)),n.tree)}incrementRemoteTreeIndex(){this.timeline.incrementRemoteTreeIndex(1)}getRemoteIndex(){return this.timeline.remoteTreeIndex-this.timeline.trimmed}getUnconfirmedChangeCount(){return this.timeline.localTreeIndex-this.timeline.remoteTreeIndex}hasChangesForRemote(){let e=this.timeline.remoteTreeIndex+this.localChangesSentToRemote,r=this.timeline.localTreeIndex;return f(e<=r,"inconsistency in getting local changes to send"),e<r}hasOnlyEmptyChangesForRemote(){let e=this.timeline.remoteTreeIndex+this.localChangesSentToRemote,r=this.timeline.localTreeIndex;return e>=r?!0:this.timeline.computeForwardChanges(e,r).length===0}createUpdateToSend(){if(!this.isReady)throw Error("cannot create updates while not ready");if(!this.hasChangesForRemote())return null;let{changes:e,count:r,reasons:n}=this.getForwardChangesForRemote(),i=++this.seq,s={session:this.session,seq:i,changes:e,count:r,reasons:n,confirmed:!1};return this.localUpdatesInFlight.push(s),s}getForwardChangesForRemote(){let e=this.timeline.remoteTreeIndex+this.localChangesSentToRemote,r=this.timeline.localTreeIndex,n=this.timeline.getChangesBetweenEntries(e,r);return this.localChangesSentToRemote+=n.count,n}commitAndCreateUpdate(e=0){f(we.isTest),this.timeline.commitLocalTree();let r=this.createUpdateToSend();return r?gr(r,e):null}resetTreesForRecovery(){return A.info("reset trees for recovery, remote:",this.getRemoteIndex(),"last index:",this.timeline.localTreeIndex,"number of entries to reapply to remote tree",this.localChangesSentToRemote),this.timeline.resetTreesForRecovery(this.getRemoteIndex(),this.localChangesSentToRemote)}trim(){if(this.timeline.isPartialLoading)return;let e=0;this.timeline.remoteTreeIndex>0?e=this.getRemoteIndex()-100:e=this.timeline.localTreeIndex-this.timeline.trimmed-100,!(e<=75)&&(this.timeline.trimmed+=e,A.debug("trim",e,"new offset:",this.timeline.trimmed,"entries.length:",this.timeline.entries.length),this.timeline.entries.splice(0,e),f(this.timeline.remoteTreeIndex===0||this.getRemoteIndex()>=0,"must have some buffer before remoteTreeIndex"))}};var se=b("remote:connection"),G=b("remote:verify"),sn=5,wr=class{constructor(t,e,r){this.projectId=e;this.callbacks=r;l(this,"treeSync");l(this,"remoteUpdates",[]);l(this,"ignoreTreeVerifies",!1);l(this,"ignoreTreeVerifyVersion",0);l(this,"shouldCrashFromDebug",!1);l(this,"loader");l(this,"needsDownload",!1);l(this,"needsProcessUpdatesAfterInit",!1);this.treeSync=new He(t),this.treeSync.waitingForTree=!0}get init(){return this.treeSync.init}setTree(t,e,r){this.treeSync.setTree(t,e,r)}get timeline(){return this.treeSync.timeline}get treeVersion(){return this.treeSync.treeVersion}get isReady(){return this.treeSync.isReady}get waitingForTree(){return this.treeSync.waitingForTree}get waitingForInitialUpdates(){return this.treeSync.waitingForInitialUpdates}get isLoading(){return this.treeSync.isLoading}get session(){return this.treeSync.session}resetSession(){this.treeSync.resetSession()}debugResetSessionAndTree(t){this.treeSync.debugResetSessionAndTree(t)}debugCrash(){this.shouldCrashFromDebug=!0}canProcessChanges(){if(this.treeSync.trim(),!this.treeSync.isReady||this.shouldCrashFromDebug){if(this.treeSync.hasOnlyEmptyChangesForRemote())return!1;let t="is not ready";throw this.treeSync.hasError?t="had an error":this.treeSync.waitingForTree?t="is waiting for tree data":this.treeSync.waitingForInitialUpdates?t="is waiting for initial updates":this.shouldCrashFromDebug&&(this.shouldCrashFromDebug=!1,t="is doing a deliberate crash test"),this.treeSync.error("cannot create local updates when the document "+t)}return!0}processViewOnly(){if(!this.treeSync.hasChangesForRemote())return;let{changes:t,count:e}=this.treeSync.getForwardChangesForRemote();se.warn("cannot create local updates when the user is a viewer, ignoring:",t),this.treeSync.confirmLocalChangesByRemote(e)}prepareLocalChanges(){}maybeSend(t){if(!this.treeSync.isReady||!this.treeSync.hasChangesForRemote())return"nothingToSend";let e=this.treeSync.localUpdatesInFlight.length;if(e>=sn)return"postpone";let r=this.treeSync.createUpdateToSend();return r?(se.debug("sending update:",e,r.changes.length,r.reasons),t.sendMessage({type:"treeUpdate",value:ie(r)}),"didSend"):"nothingToSend"}resumeLoadingScopes(){this.loader?.resumeLoadingScopes()}handleRows(){throw Error("Crdt tree updates cannot be handled by Json data handler")}handleConfirmRows(){throw Error("Crdt tree updates cannot be handled by Json data handler")}get hasUpdatesToProcess(){return!this.waitingForTree&&!this.needsDownload&&(this.needsProcessUpdatesAfterInit||this.remoteUpdates.length>0)}handleInit(t,e){this.remoteUpdates.length=0,this.needsDownload=this.treeSync.handleInit(t,e),this.needsProcessUpdatesAfterInit=!0}handleMigration(t){this.treeSync.treeVersion=t}handleReload(t){this.remoteUpdates.length=0,this.treeSync.hasError=!0;let e=new Error(t||"Server reloaded document.");this.callbacks.error(e)}handleTreeVerify(t,e,r){if(!this.treeSync.isReady||this.ignoreTreeVerifies||this.ignoreTreeVerifyVersion===e)return;if(!this.treeSync.verify(e,r)){let s=this.treeSync.timeline.getTreeForVersion(e);if(s){let d=this.treeSync.timeline.entries.slice();this.verifyLocalTreeWithServer(t,s,e,d)}this.remoteUpdates.length=0,this.treeSync.hasError=!0;let a=new Error("Local document out of sync with document on server.");this.callbacks.error(a);return}let n=Re(),i=!!window.location.hostname.match(/development/u);if(n||i){let s=this.treeSync.timeline.getTreeForVersion(e);if(s){let a=this.treeSync.timeline.entries.slice();this.verifyLocalTreeWithServer(t,s,e,a)}}}async verifyLocalTreeWithServer(t,e,r,n){try{let i=t.replace(/\d+\.json/u,r+".json"),s=await fetch(i,await Q.withAuthorizationHeader({}));if(!s.ok)throw Error(`unable to fetch document json: ${s.status} ${s.statusText}`);let a=await s.text(),d=await this.loadServerTree(a,i,r);this.compareTreeWithServerJson(e,d,r,n)}catch(i){G.error("Error:",i)}}compareTreeWithServerJson(t,e,r,n){G.debug("local:",t.computeTreeHash(),t.size(),"remote:",e.computeTreeHash(),e.size(),"version:",r);let i,s=[];return _e(t,e,s)?(G.warn(`trees are different
`+s.join(`
`)),n&&G.debug("timeline.entries",n),i=Error("Local document different from server document."),G.reportError(i,{differences:s,changes:n?.slice(-25).map(d=>d.changes)})):s.length>0?G.debug(`trees have warnings:
`+s.join(`
`)):G.debug("trees are same"),i}handleTreeUpdate(t){this.remoteUpdates.push(t)}processRemoteUpdates(){if(this.treeSync.waitingForTree)return;let t;try{if(f(!this.timeline.tree.hasUncommittedChanges(),"tree must not have uncommitted changes"),this.shouldCrashFromDebug)throw this.shouldCrashFromDebug=!1,Error("RemoteDocument CrashTest");for(;this.remoteUpdates.length>0;){let e=this.remoteUpdates.shift();if(!e)break;t=e,this.ensureAllScopesAreLoaded(e),this.treeSync.handleRemoteUpdate(e),this.loader&&!Be(e)&&this.loader.addNodeChanges(e.changes)}if(this.loader){let e=this.timeline.tree.root.children;if(!e.some(n=>M(n)&&n.isValid())){se.info("cannot show any page, forcing load of next page");let n=e.find(s=>M(s));if(!n)throw Error("No scope to load");let i=this.loader.loadScope(n.id);if(!i)throw Error("Unable to load scope");this.treeSync.loadOneScope(i,!1)}}this.callbacks.updateProcessed(this.timeline.tree)}catch(e){let r=be(e);throw this.remoteUpdates.length=0,se.error("Error processing remote updates:",r),se.debug("Last update:",t),this.treeSync.error(r.message),this.callbacks.errorRecoverable(),r}}ensureAllScopesAreLoaded(t){if(!this.loader||!ze(t))return;let e=new Set;for(let r of t.changes)r.previousScope&&(e.add(r.previousScope),e.add(r.to.parentid));for(let r of e){if(this.loader.hasLoadedScope(r))continue;let n=this.loader.loadScope(r);n&&this.treeSync.loadOneScope(n,!1)}}createLoader(t,e,r){this.needsDownload=!1,this.loader?.scheduler.cancel();let n=new H(e,t,r);return this.loader=n,this.loader}async verifyTreeWithServer(){let t=new URL(`/projects/${this.projectId}/tree/latest?forceSnapshot=true`,window.location.href),e;try{this.ignoreTreeVerifies=!0,e=await fetch(t,await Q.withAuthorizationHeader({}))}finally{this.ignoreTreeVerifies=!1}if(!e.ok)throw Error(`unable to fetch document json: ${e.status} ${e.statusText}`);let r=e.headers.get("etag")||"",n=Number.parseInt(r.match(/Version-(\d+)/u)?.[1]??"0",10);if(!Number.isFinite(n)||n<=0)throw Error(`unable to parse document tree version from: ${r}`);let i=this.treeSync.treeVersion-n,s=this.treeSync.timeline.getTreeForVersion(n);if(!s)throw Error(`unable to get the local tree for version ${n}`);this.ignoreTreeVerifyVersion=n;let a=await e.text(),d=await this.loadServerTree(a,t.toString(),n),c=this.compareTreeWithServerJson(s,d,n);if(c)throw c;return i}async loadServerTree(t,e,r){let n,i=new H(r,e,{partialParsing:!0,loadInBackground:!0,loadedData:t,requestIdleCallback:this.callbacks.requestIdleCallback});return i.on("loadedFirstData",s=>{i.on("loadedScope",a=>{let d=s.root.children.findIndex(c=>c.id===a.id);s.remove(a.id),s.insertNode(a,s.root.id,d),s=s.commit()}),i.on("loadedAllData",()=>{n=s})}),await i.start(),f(n,"loadedAllData not called"),n}clearRemoteUpdates(){this.remoteUpdates.length=0}get localUpdatesInFlight(){return this.treeSync.localUpdatesInFlight}get localUpdatesAtInit(){return this.treeSync.localUpdatesAtInit}get hasError(){return this.treeSync.hasError}sendRemainingInflightUpdates(t){if(this.localUpdatesInFlight.length===0)return!1;let e=this.treeSync.createUpdateToSend();return e&&t.sendMessage({type:"treeUpdate",value:ie(e)}),!0}resendPreviousLocalUpdates(t){f(this.isReady);let e=this.localUpdatesAtInit.filter(r=>!r.confirmed);if(e.length!==0){se.debug("resending local updates:",e.length);for(let r of e)t.sendMessage({type:"treeUpdate",value:ie(r)})}}cancelAndClearLoader(){this.loader?.scheduler.cancel(),this.loader=void 0}finishLoading(){this.loader=void 0}loadOneScope(t,e){return this.treeSync.loadOneScope(t,e)}loadedAllScopes(){this.treeSync.loadedAllScopes()}hasUnconfirmedChanges(){return this.treeSync.getUnconfirmedChangeCount()>0}resetTreesForRecovery(){return this.treeSync.resetTreesForRecovery()}error(t){return this.treeSync.error(t)}};export{Gt as a,cn as b,$t as c,Jt as d,De as e,Nr as f,Ur as g,ai as h,Lr as i,Dr as j,Br as k,Tn as l,Cn as m,Rn as n,et as o,H as p,br as q,wr as r};
//# sourceMappingURL=https://app.framerstatic.com/chunk-ELHX4CJ5.mjs.map
